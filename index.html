<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://s1.ax1x.com/2023/10/24/piZf959.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mobile OS Simulator</title>
    <style>
        :root {
            --bg-url: url('https://via.placeholder.com/1080x2340/333/666?text=Wallpaper');
            --main-font-family: -apple-system, sans-serif;
            --main-font-size: 14px;
            --main-font-color: #ffffff;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            display: flex; justify-content: center; align-items: center;
            font-family: var(--main-font-family);
        }

        #phone-wrapper {
            position: relative;
            width: 100vw; height: 216.6vw;
            max-height: 100vh; max-width: 46.15vh;
            background: var(--bg-url) center/cover no-repeat;
            overflow: hidden; display: flex; flex-direction: column; align-items: center;
            border-radius: 40px; box-shadow: 0 0 50px rgba(0,0,0,0.5);
            color: var(--main-font-color);
        }

        /* ç»„ä»¶æ ·å¼ */
        .widget-container {
            width: 90%; margin-top: 12%;
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(15px);
            border-radius: 25px; padding: 12px; display: grid;
            grid-template-columns: repeat(4, 1fr); gap: 8px; box-sizing: border-box;
        }
        .widget-item {
            background: rgba(255, 255, 255, 0.7); border-radius: 12px;
            padding: 6px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 10px; color: #000;
        }
        .editable { outline: none; border-bottom: 1px dashed transparent; }
        .editable:focus { border-bottom-color: #007aff; }

        .app-grid {
            width: 90%; display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 15px; margin-top: 25px;
        }
        .iscreen-img-box {
            grid-column: span 2; grid-row: span 2;
            width: 100%; aspect-ratio: 1/1; border-radius: 22%;
            overflow: hidden; background: #fff;
        }
        .iscreen-img-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .app-item { display: flex; flex-direction: column; align-items: center; }
        .app-icon { width: 60px; height: 60px; border-radius: 16px; margin-bottom: 4px; display: flex; align-items: center; justify-content: center; font-size: 30px; }

        /* å¾®ä¿¡å…¨å±å®¹å™¨ */
        .screen-full {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #ededed; z-index: 100; display: none; flex-direction: column; color: #000;
        }
        .sub-header {
            padding: 50px 15px 15px; display: flex; align-items: center;
            background: #ededed; font-weight: bold; font-size: 17px;
        }
        .back-btn { font-size: 26px; margin-right: 15px; cursor: pointer; line-height: 1; }

        .menu-item {
            background: #fff; margin: 10px 15px; padding: 15px;
            border-radius: 12px; display: flex; justify-content: space-between;
            align-items: center; font-size: 16px;
        }
        .arrow-r::after { content: 'â€º'; color: #ccc; font-size: 20px; }

        .setting-box { padding: 15px; flex:1; overflow-y:auto; }
        .input-bubble { width: 100%; border: none; padding: 12px; border-radius: 10px; margin: 10px 0; box-sizing: border-box; background: #fdfdfd; }
        
        .contact-item { display: flex; align-items: center; padding: 12px; background: #fff; border-bottom: 0.5px solid #eee; }
        .contact-avatar { width: 45px; height: 45px; border-radius: 6px; margin-right: 12px; object-fit: cover; }

        /* å¾®ä¿¡åº•éƒ¨å¯¼èˆª */
        .wx-navbar {
            height: 60px; background: #f7f7f7; border-top: 0.5px solid #ddd;
            display: flex; justify-content: space-around; align-items: center;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #555; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }

        /* èŠå¤©æ°”æ³¡å¢å¼º */
        .chat-row { display: flex; margin-bottom: 15px; width: 100%; }
        .chat-row.self { justify-content: flex-end; }
        .chat-row.friend { justify-content: flex-start; }
        .bubble-avatar { width: 40px; height: 40px; border-radius: 4px; }
        .bubble-content { 
            padding: 8px 12px; border-radius: 6px; max-width: 65%; 
            font-size: 15px; word-break: break-all; position: relative;
        }
        .self .bubble-content { background: #95ec69; margin-right: 10px; }
        .friend .bubble-content { background: #fff; margin-left: 10px; border: 0.5px solid #ddd; }

        /* Dock */
        .dock {
            position: absolute; bottom: 20px; width: 90%; height: 85px;
            background: rgba(255,255,255,0.3); backdrop-filter: blur(20px);
            border-radius: 30px; display: flex; justify-content: space-around; align-items: center;
        }
    </style>
</head>
<body>

<div id="phone-wrapper">
    <div class="widget-container">
        <div class="widget-item"><div id="widget-date">--</div><div id="widget-day">--</div></div>
        <div class="widget-item">ğŸ“¶ WiFi<br><span style="color:#007aff">On</span></div>
        <div class="widget-item" style="font-size:22px; font-weight:bold;" id="widget-time">--:--</div>
        <div class="widget-item">ğŸ”‹ <span id="bat-val">--%</span></div>
        <div class="widget-item"><div class="editable" contenteditable="true">352GB/511GB</div></div>
        <div class="widget-item" style="grid-column: span 2;">
            <div class="editable" contenteditable="true">iPhone 16 Pro</div>
            <div class="editable" contenteditable="true" style="font-weight:bold;">ï£¿ A18 Pro</div>
        </div>
        <div class="widget-item"><div class="editable" contenteditable="true">iOS 26.2.1</div></div>
    </div>

    <div class="app-grid">
        <div class="iscreen-img-box" onclick="pickImg('img-left')"><img id="img-left" src="https://via.placeholder.com/300?text=Pic+1"></div>
        <div class="app-item" onclick="openScreen('theme-screen')"><div class="app-icon" style="background:#fff6f9;">ğŸ¨</div><div style="font-size:12px; color:#fff">ä¸»é¢˜</div></div>
        <div class="app-item" onclick="openWx()"><div class="app-icon" style="background:#07c160; color:#fff; font-size:16px;">å¾®ä¿¡</div><div style="font-size:12px; color:#fff">å¾®ä¿¡</div></div>
        <div class="app-item"><div class="app-icon" style="background:#1c99ff; color:#fff;">ğŸ“–</div><div style="font-size:12px; color:#fff">ä¸–ç•Œä¹¦</div></div>
        <div class="app-item" onclick="openScreen('settings-screen')"><div class="app-icon" style="background:#000; color:#fff;">âš™ï¸</div><div style="font-size:12px; color:#fff">è®¾ç½®</div></div>
        <div class="app-item"><div class="app-icon" style="background:#fff;">ğŸ›’</div><div style="font-size:12px; color:#fff">å•†åº—</div></div>
        <div class="app-item"><div class="app-icon" style="background:#000; color:#fff;">ğ•</div><div style="font-size:12px; color:#fff">X</div></div>
        <div class="iscreen-img-box" onclick="pickImg('img-right')"><img id="img-right" src="https://via.placeholder.com/300?text=Pic+2"></div>
    </div>

    <div class="dock">
        <div class="app-icon" style="background:#4cd964;">ğŸ“</div>
        <div class="app-icon" style="background:#fff;">ğŸ§­</div>
        <div class="app-icon" style="background: linear-gradient(180deg, #5AC8FA 0%, #007AFF 100%); color:#fff;">â˜€ï¸</div>
        <div class="app-icon" style="background:#000;">ğŸ“·</div>
    </div>

    <div id="wechat-screen" class="screen-full">
        <div id="wx-page-msg" style="display:flex; flex-direction:column; height:100%;">
            <div class="sub-header">
                <span class="back-btn" onclick="closeScreen('wechat-screen')">â€¹</span>
                <span style="flex:1">å¾®ä¿¡</span>
                <span style="font-size:24px; cursor:pointer;" onclick="showAddModal('friend')">+</span>
            </div>
            <div id="chat-list" style="flex:1; background:#fff; overflow-y:auto;">
                <div class="contact-item"><div class="contact-avatar" style="background:#eee;"></div><span>å¾®ä¿¡å›¢é˜Ÿ</span></div>
            </div>
        </div>

        <div id="wx-page-me" style="display:none; flex-direction:column; height:100%; background:#ededed;">
            <div class="sub-header" style="background:#fff; padding-bottom:30px;">
                <img id="me-avatar-img" src="https://via.placeholder.com/60" style="width:60px; height:60px; border-radius:8px; margin-right:15px;" onclick="pickImg('me-avatar-img')">
                <div style="flex:1">
                    <div id="me-nick-display" style="font-size:20px; font-weight:bold;">æœªè®¾ç½®æ˜µç§°</div>
                    <div style="color:#888; font-size:14px; margin-top:4px;">å¾®ä¿¡å·ï¼š<span id="me-id-display">æœªè®¾ç½®</span></div>
                    <div id="me-status-display" style="display:inline-block; border:1px solid #ccc; border-radius:10px; padding:2px 8px; font-size:12px; margin-top:5px; color:#555;">+ çŠ¶æ€</div>
                </div>
            </div>
            <div class="menu-item arrow-r" onclick="showService()">æœåŠ¡</div>
            <div class="menu-item arrow-r" onclick="openMyBios()">æˆ‘çš„äººè®¾</div>
            <div class="menu-item arrow-r" onclick="openMeSettings()">ä¸ªäººä¿¡æ¯è®¾ç½®</div>
        </div>

        <div class="wx-navbar">
            <div class="nav-item" onclick="switchWxTab('msg')"><div class="nav-icon">ğŸ’¬</div>æ¶ˆæ¯</div>
            <div class="nav-item"><div class="nav-icon">ğŸ§­</div>å‘ç°</div>
            <div class="nav-item" onclick="switchWxTab('me')"><div class="nav-icon">ğŸ‘¤</div>æˆ‘</div>
        </div>
    </div>

    <div id="chat-screen" class="screen-full" style="background:#f3f3f3;">
        <div class="sub-header" style="background:#f3f3f3; border-bottom:0.5px solid #ddd;">
            <span class="back-btn" onclick="closeScreen('chat-screen')">â€¹</span>
            <span id="chat-title" style="flex:1; text-align:center; margin-right:30px;">å¥½å‹</span>
        </div>
        <div id="chat-content" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column;"></div>
        <div style="background:#f7f7f7; padding:10px; display:flex; align-items:flex-end; gap:8px; border-top:0.5px solid #ddd;">
            <div onclick="triggerAiReply()" style="font-size:24px; cursor:pointer; padding-bottom:5px;">âš¡</div>
            <textarea id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1; min-height:36px; max-height:100px; border:none; border-radius:5px; padding:8px; font-size:16px; outline:none; resize:none;"></textarea>
            <button id="msg-send-btn" onclick="sendMessage()" style="display:none; background:#07c160; color:#fff; border:none; padding:8px 15px; border-radius:5px; font-weight:bold;">å‘é€</button>
        </div>
    </div>

    <div id="my-bios-screen" class="screen-full">
        <div class="sub-header">
            <span class="back-btn" onclick="closeScreen('my-bios-screen')">â€¹</span>
            <span style="flex:1">æˆ‘çš„äººè®¾</span>
            <span style="font-size:24px; cursor:pointer;" onclick="showAddModal('me')">+</span>
        </div>
        <div id="bios-list" style="flex:1; background:#fff; overflow-y:auto;"></div>
    </div>

    <div id="add-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:2000;">
        <div style="background:#fff; width:80%; padding:20px; border-radius:15px; color:#000;">
            <h3 id="modal-title" style="margin-top:0; text-align:center;">æ·»åŠ </h3>
            <p style="text-align:center; font-size:12px; color:#888;">ä¸Šä¼ å¤´åƒ</p>
            <input type="file" id="add-head" accept="image/*" style="margin-bottom:15px; width:100%;">
            <input type="text" id="add-nick" placeholder="å§“å/æ˜µç§°" class="input-bubble" style="background:#f5f5f5">
            <input type="text" id="add-mark" placeholder="å¤‡æ³¨" class="input-bubble" style="background:#f5f5f5" id="mark-row">
            <textarea id="add-bio" placeholder="è®¾å®šæè¿°" class="input-bubble" style="background:#f5f5f5; height:80px;"></textarea>
            <div style="display:flex; justify-content: space-between; margin-top:10px;">
                <button onclick="document.getElementById('add-modal').style.display='none'" style="padding:10px 25px; border:none; border-radius:8px; background:#eee;">å–æ¶ˆ</button>
                <button onclick="confirmAddAny()" style="background:#07c160; color:#fff; border:none; padding:10px 25px; border-radius:8px;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="me-settings-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('me-settings-screen')">â€¹</span><span>ä¸ªäººä¿¡æ¯</span></div>
        <div class="setting-box">
            <input type="text" id="set-me-nick" placeholder="æ˜µç§°" class="input-bubble">
            <input type="text" id="set-me-id" placeholder="å¾®ä¿¡å·" class="input-bubble">
            <input type="text" id="set-me-status" placeholder="çŠ¶æ€" class="input-bubble">
            <button onclick="saveMeSettings()" style="width:100%; height:50px; background:#07c160; color:#fff; border:none; border-radius:12px; margin-top:20px;">ä¿å­˜</button>
        </div>
    </div>

    <div id="settings-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('settings-screen')">â€¹</span><span>è®¾ç½®</span></div>
        <div class="menu-item arrow-r" onclick="openScreen('api-screen')">API è®¾ç½®</div>
    </div>

    <div id="api-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('api-screen')">â€¹</span><span>API è®¾ç½®</span></div>
        <div class="setting-box">
            <input type="text" id="api-url" class="input-bubble" placeholder="API åœ°å€">
            <input type="password" id="api-key" class="input-bubble" placeholder="API Key">
            <div id="model-name-display" style="font-size:12px; margin:5px;">æ¨¡å‹ï¼šæœªé€‰æ‹©</div>
            <button onclick="fetchModels()" style="color:#007aff; border:none; background:none;">è·å–æ¨¡å‹åˆ—è¡¨</button>
            <div id="model-list-container" style="display:none; max-height:100px; overflow-y:auto; border:1px solid #eee; margin-top:5px;"></div>
            <input type="number" id="api-memory" class="input-bubble" value="25" placeholder="è®°å¿†æ¡æ•°">
            <button onclick="saveApiSettings()" style="width:100%; height:50px; background:#07c160; color:#fff; border:none; border-radius:12px; margin-top:20px;">ä¿å­˜å…¨éƒ¨è®¾ç½®</button>
        </div>
    </div>

    <div id="theme-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('theme-screen')">â€¹</span><span>ä¸»é¢˜è®¾ç½®</span></div>
        <div class="menu-item arrow-r" onclick="openScreen('font-screen')">å­—ä½“è®¾ç½®</div>
        <div class="menu-item arrow-r" onclick="openScreen('wallpaper-screen')">ä¸»å±å¹•å£çº¸</div>
    </div>

    <div id="font-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('font-screen')">â€¹</span><span>å­—ä½“è®¾ç½®</span></div>
        <div class="setting-box">
            <input type="text" id="font-url" class="input-bubble" placeholder="å­—ä½“é“¾æ¥">
            <input type="range" id="font-resizer" min="10" max="30" value="14" style="width:100%">
            <input type="color" id="font-color" style="width:50px; height:50px;">
            <button onclick="applyFontSettings()" style="width:100%; height:50px; background:#07c160; color:#fff; border:none; border-radius:12px;">åº”ç”¨</button>
        </div>
    </div>

    <div id="wallpaper-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('wallpaper-screen')">â€¹</span><span>å£çº¸</span></div>
        <div class="setting-box">
            <div class="menu-item arrow-r" onclick="document.getElementById('wall-file').click()">é€‰å–ç›¸å†Œå›¾ç‰‡</div>
            <input type="file" id="wall-file" hidden accept="image/*">
            <div id="wall-preview" style="height:200px; background:#ccc; border-radius:15px; background-size:cover;"></div>
            <button onclick="saveWallpaper()" style="width:100%; height:50px; background:#07c160; color:#fff; border:none; border-radius:12px; margin-top:20px;">ä¿å­˜</button>
        </div>
    </div>

</div>

<input type="file" id="hidden-picker" style="display:none;" accept="image/*">

<script>
// --- åŸºç¡€ç³»ç»Ÿé€»è¾‘ ---
function syncTime() {
    const d = new Date();
    document.getElementById('widget-time').innerText = d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
    document.getElementById('widget-date').innerText = (d.getMonth()+1) + "æœˆ" + d.getDate() + "æ—¥";
    const days = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"];
    document.getElementById('widget-day').innerText = days[d.getDay()];
}
setInterval(syncTime, 1000); syncTime();

function openScreen(id) { document.getElementById(id).style.display = 'flex'; }
function closeScreen(id) { document.getElementById(id).style.display = 'none'; }

if (navigator.getBattery) {
    navigator.getBattery().then(bat => {
        const update = () => document.getElementById('bat-val').innerText = Math.floor(bat.level*100) + "%";
        update(); bat.onlevelchange = update;
    });
}

let activeTarget = '';
function pickImg(id) { activeTarget = id; document.getElementById('hidden-picker').click(); }
document.getElementById('hidden-picker').onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            document.getElementById(activeTarget).src = ev.target.result;
            if(activeTarget === 'me-avatar-img') currentUserAvatar = ev.target.result;
        }
        reader.readAsDataURL(file);
    }
}

// --- å¾®ä¿¡å¢å¼ºé€»è¾‘ ---
let currentUserAvatar = 'https://via.placeholder.com/60';
let currentUserName = "æˆ‘";
let currentMeId = "wxid_888";
let currentStatus = "å¼€å¿ƒ";
let userBalance = null;
let currentMyBio = "ä½ æ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚"; // å½“å‰ç”Ÿæ•ˆçš„ç”¨æˆ·äººè®¾

let friends = {}; 
let chatHistory = {};
let currentChatFriend = "";
let apiSettings = { url: '', key: '', model: '', memory: 25 };

function openWx() {
    openScreen('wechat-screen');
    switchWxTab('msg');
}

function switchWxTab(tab) {
    document.getElementById('wx-page-msg').style.display = (tab === 'msg' ? 'flex' : 'none');
    document.getElementById('wx-page-me').style.display = (tab === 'me' ? 'flex' : 'none');
}

function openMeSettings() {
    document.getElementById('set-me-nick').value = currentUserName;
    document.getElementById('set-me-id').value = currentMeId;
    document.getElementById('set-me-status').value = currentStatus;
    openScreen('me-settings-screen');
}

function saveMeSettings() {
    currentUserName = document.getElementById('set-me-nick').value;
    currentMeId = document.getElementById('set-me-id').value;
    currentStatus = document.getElementById('set-me-status').value;
    document.getElementById('me-nick-display').innerText = currentUserName;
    document.getElementById('me-id-display').innerText = currentMeId;
    document.getElementById('me-status-display').innerText = currentStatus;
    closeScreen('me-settings-screen');
}

function showService() {
    if (userBalance === null) {
        let val = prompt("è¯·è¾“å…¥åˆå§‹ä½™é¢ï¼š", "8888.00");
        if (val !== null) userBalance = val;
    }
    alert("å¾®ä¿¡æ”¯ä»˜ä½™é¢ï¼šÂ¥" + (userBalance || "0.00"));
}

function openMyBios() { openScreen('my-bios-screen'); }

// å¼¹çª—é€»è¾‘
let modalMode = 'friend'; 
function showAddModal(mode) {
    modalMode = mode;
    document.getElementById('add-modal').style.display = 'flex';
    document.getElementById('modal-title').innerText = mode === 'friend' ? 'æ·»åŠ å¥½å‹' : 'æ·»åŠ æˆ‘çš„äººè®¾';
    document.getElementById('add-mark').style.display = mode === 'friend' ? 'block' : 'none';
}

function confirmAddAny() {
    const nick = document.getElementById('add-nick').value;
    const mark = document.getElementById('add-mark').value;
    const bio = document.getElementById('add-bio').value;
    const headFile = document.getElementById('add-head').files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const avatar = e.target.result;
        if(modalMode === 'friend') {
            const displayName = mark || nick;
            friends[displayName] = { avatar, bio: bio || "æ™®é€šå¥½å‹" };
            chatHistory[displayName] = [];
            renderFriendList();
        } else {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.onclick = () => { 
                currentMyBio = bio; 
                alert("å·²åˆ‡æ¢ä¸ºä½ çš„äººè®¾ï¼š" + nick); 
                closeScreen('my-bios-screen');
            };
            div.innerHTML = `<img src="${avatar}" class="contact-avatar"><span>${nick}</span>`;
            document.getElementById('bios-list').appendChild(div);
        }
        document.getElementById('add-modal').style.display = 'none';
    };

    if(headFile) reader.readAsDataURL(headFile);
    else reader.onload({target:{result:'https://via.placeholder.com/45'}});
}

function renderFriendList() {
    const list = document.getElementById('chat-list');
    list.innerHTML = "";
    for(let name in friends) {
        const item = document.createElement('div');
        item.className = 'contact-item';
        item.onclick = () => openChat(name);
        item.innerHTML = `<img src="${friends[name].avatar}" class="contact-avatar"><span>${name}</span>`;
        list.appendChild(item);
    }
}

function openChat(name) {
    currentChatFriend = name;
    document.getElementById('chat-title').innerText = name;
    document.getElementById('chat-content').innerHTML = "";
    chatHistory[name].forEach(m => renderMessage(m.text, m.type));
    openScreen('chat-screen');
}

function renderMessage(text, type) {
    const chatBox = document.getElementById('chat-content');
    const row = document.createElement('div');
    row.className = `chat-row ${type === 'self' ? 'self' : 'friend'}`;
    
    const avatarImg = type === 'self' ? currentUserAvatar : friends[currentChatFriend].avatar;
    const avatarHtml = `<img src="${avatarImg}" class="bubble-avatar">`;
    const bubbleHtml = `<div class="bubble-content">${text}</div>`;
    
    row.innerHTML = type === 'self' ? (bubbleHtml + avatarHtml) : (avatarHtml + bubbleHtml);
    chatBox.appendChild(row);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// æ¶ˆæ¯å‘é€ä¸ AI
document.getElementById('msg-input').oninput = function() {
    document.getElementById('msg-send-btn').style.display = this.value.trim().length > 0 ? 'block' : 'none';
};

async function sendMessage() {
    const input = document.getElementById('msg-input');
    const content = input.value.trim();
    if(!content) return;
    renderMessage(content, 'self');
    chatHistory[currentChatFriend].push({text: content, type: 'self'});
    input.value = "";
    document.getElementById('msg-send-btn').style.display = 'none';
}

async function triggerAiReply() {
    if(!apiSettings.key) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API");
    
    const friendInfo = friends[currentChatFriend];
    // ç³»ç»Ÿæç¤ºè¯ï¼šèåˆäº†ç”¨æˆ·çš„äººè®¾å’Œ AI çš„äººè®¾ï¼Œå¹¶ä¸¥ç¦åŠ¨ä½œæè¿°
    const systemPrompt = `ä½ ç°åœ¨æ¨¡æ‹Ÿå¾®ä¿¡èŠå¤©ã€‚
    ä½ çš„åå­—/äººè®¾æ˜¯ï¼š${friendInfo.bio}ã€‚
    å¯¹æ–¹(User)çš„åå­—æ˜¯ï¼š${currentUserName}ï¼Œäººè®¾æ˜¯ï¼š${currentMyBio}ã€‚
    è§„åˆ™ï¼šä»…è¾“å‡ºå¯¹è¯å†…å®¹ï¼Œä¸¥ç¦å‡ºç°ä»»ä½•åŠ¨ä½œæè¿°ï¼ˆå¦‚ *ç¬‘*ã€(æ¡æ‰‹)ï¼‰ã€ä¸¥ç¦å¿ƒç†æå†™ã€ä¸¥ç¦æ—ç™½ã€‚ç›´æ¥å›å¤å¯¹è¯ï¼ŒåƒçœŸæ­£çš„å¾®ä¿¡èŠå¤©ä¸€æ ·ã€‚`;

    try {
        const context = chatHistory[currentChatFriend].slice(-apiSettings.memory).map(m => ({
            role: m.type === 'self' ? 'user' : 'assistant',
            content: m.text
        }));

        const response = await fetch(`${apiSettings.url}/chat/completions`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiSettings.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: apiSettings.model,
                messages: [{role: "system", content: systemPrompt}, ...context]
            })
        });
        const data = await response.json();
        const aiText = data.choices[0].message.content;
        
        renderMessage(aiText, 'friend');
        chatHistory[currentChatFriend].push({text: aiText, type: 'friend'});
    } catch (e) {
        alert("AI å”¤é†’å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API è®¾ç½®");
    }
}

// --- å…¶ä½™åŸä»£ç é€»è¾‘ ---
async function fetchModels() {
    const url = document.getElementById('api-url').value;
    const key = document.getElementById('api-key').value;
    const listContainer = document.getElementById('model-list-container');
    if(!url || !key) return alert("æœªå¡« API ä¿¡æ¯");
    try {
        const res = await fetch(`${url}/models`, { headers: { 'Authorization': `Bearer ${key}` } });
        const data = await res.json();
        listContainer.innerHTML = "";
        data.data.forEach(m => {
            const item = document.createElement('div');
            item.style = "padding:8px; font-size:12px; cursor:pointer;";
            item.innerText = m.id;
            item.onclick = () => { apiSettings.model = m.id; document.getElementById('model-name-display').innerText="æ¨¡å‹ï¼š"+m.id; listContainer.style.display='none'; };
            listContainer.appendChild(item);
        });
        listContainer.style.display = 'block';
    } catch (e) { alert("è·å–å¤±è´¥"); }
}

function saveApiSettings() {
    apiSettings.url = document.getElementById('api-url').value;
    apiSettings.key = document.getElementById('api-key').value;
    apiSettings.memory = parseInt(document.getElementById('api-memory').value) || 25;
    alert("å·²ä¿å­˜"); closeScreen('api-screen');
}

function applyFontSettings() {
    const size = document.getElementById('font-resizer').value + "px";
    const color = document.getElementById('font-color').value;
    document.documentElement.style.setProperty('--main-font-size', size);
    document.documentElement.style.setProperty('--main-font-color', color);
    const wrapper = document.getElementById('phone-wrapper');
    wrapper.style.fontSize = size; wrapper.style.color = color;
    closeScreen('font-screen');
}

let tempWallData = "";
document.getElementById('wall-file').onchange = function(e) {
    if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            tempWallData = ev.target.result;
            document.getElementById('wall-preview').style.backgroundImage = `url(${tempWallData})`;
        };
        reader.readAsDataURL(e.target.files[0]);
    }
};
function saveWallpaper() {
    if(tempWallData) { document.documentElement.style.setProperty('--bg-url', `url(${tempWallData})`); closeScreen('wallpaper-screen'); }
}
</script>
</body>
</html>
