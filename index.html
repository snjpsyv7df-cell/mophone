<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://s1.ax1x.com/2023/10/24/piZf959.jpg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mobile OS Simulator</title>
    <style>
        :root {
            --bg-url: url('https://via.placeholder.com/1080x2340/333/666?text=Wallpaper');
            --main-font-family: -apple-system, sans-serif;
            --main-font-size: 14px;
            --main-font-color: #ffffff;
        }

        body, html {
            margin: 0;
            padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            display: flex; justify-content: center; align-items: center;
            font-family: var(--main-font-family);
        }

        #phone-wrapper {
            position: relative;
            width: 100vw; 
            height: 100vh;
            background: var(--bg-url) center/cover no-repeat;
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            border-radius: 0; 
            box-shadow: none;
            color: var(--main-font-color);
        }

        /* --- å¼€å±åŠ¨ç”»æ ·å¼ Start --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .splash-title {
            font-size: 48px; margin-bottom: 30px; font-family: sans-serif; z-index: 10;
        }
        .title-momo { font-weight: bold; color: #000000; }
        .title-chat { font-weight: bold; color: #87CEFA; } /* æ·¡è“è‰² */

        /* å¿ƒå½¢è™šçº¿åŠ¨ç”» */
        .heart-svg { width: 120px; height: 120px; overflow: visible; }
        .heart-path {
            fill: none; 
            stroke: #FF69B4; /* ç²‰è‰²çº¿æ¡ */
            stroke-width: 3;
            stroke-dasharray: 10, 10; /* è™šçº¿ */
            stroke-linecap: round;
            animation: dashMove 1.5s linear infinite;
        }
        @keyframes dashMove {
            to { stroke-dashoffset: -40; }
        }

        /* æ˜Ÿæ˜Ÿè£…é¥° */
        .star {
            position: absolute; color: #FFD700; font-size: 20px;
            animation: twinkle 2s infinite alternate;
        }
        @keyframes twinkle {
            0% { opacity: 0.3; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        /* åº•éƒ¨æ–‡å­— */
        .splash-footer {
            position: absolute; bottom: 30px; right: 30px;
            color: #999; font-size: 12px; font-weight: normal;
        }
        /* --- å¼€å±åŠ¨ç”»æ ·å¼ End --- */

        .widget-container {
            width: 92%;
            height: 160px;
            margin-top: calc(12% + env(safe-area-inset-top));
            background: rgba(255, 255, 255, 0.4); 
            backdrop-filter: blur(15px);
            border-radius: 28px;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 10px;
            box-sizing: border-box;
        }

        .widget-item {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 12px;
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center; 
            font-size: 11px; 
            color: #000;
            overflow: hidden;
            text-align: center;
        }

        #widget-time {
            font-size: 20px;
            font-weight: bold;
        }

        .editable { outline: none; border-bottom: 1px dashed transparent;
        }
        .editable:focus { border-bottom-color: #007aff;
        }

        .app-grid {
            width: 90%;
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 15px; margin-top: 25px;
        }
        .iscreen-img-box {
            grid-column: span 2;
            grid-row: span 2;
            width: 100%; aspect-ratio: 1/1; border-radius: 22%;
            overflow: hidden; background: #fff;
        }
        .iscreen-img-box img { width: 100%; height: 100%; object-fit: cover;
        }
        
        .app-item { display: flex;
        flex-direction: column; align-items: center; }
        .app-icon { width: 60px; height: 60px; border-radius: 16px;
        margin-bottom: 4px; display: flex; align-items: center; justify-content: center; font-size: 30px;
        }

        .screen-full {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #ededed; z-index: 100; display: none; flex-direction: column; color: #000;
        }
        .sub-header {
            padding: 50px 15px 15px;
            display: flex; align-items: center;
            background: #ededed; font-weight: bold; font-size: 17px;
        }
        .back-btn { font-size: 26px; margin-right: 15px; cursor: pointer; line-height: 1;
        }

        .menu-item {
            background: #fff;
            margin: 10px 15px; padding: 15px;
            border-radius: 12px; display: flex; justify-content: space-between;
            align-items: center; font-size: 16px;
        }
        .arrow-r::after { content: 'â€º'; color: #ccc; font-size: 20px;
        }

        .setting-box { padding: 15px; flex:1; overflow-y:auto;
        }
        .input-bubble { width: 100%; border: none; padding: 12px; border-radius: 10px;
        margin: 10px 0; box-sizing: border-box; background: #fdfdfd; }
        
        .contact-item { display: flex;
        align-items: center; padding: 12px; background: #fff; border-bottom: 0.5px solid #eee;
        }
        .contact-avatar { width: 45px; height: 45px; border-radius: 6px; margin-right: 12px; object-fit: cover;
        }

        .wx-navbar {
            height: 60px;
            background: #f7f7f7; border-top: 0.5px solid #ddd;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #555;
        }
        .nav-icon { font-size: 20px; margin-bottom: 2px;
        }

        .chat-row { display: flex; margin-bottom: 15px; width: 100%;
        }
        .chat-row.self { justify-content: flex-end;
        }
        .chat-row.friend { justify-content: flex-start;
        }
        .bubble-avatar { width: 40px; height: 40px; border-radius: 4px;
        }
        .bubble-content { 
            padding: 8px 12px;
            border-radius: 6px; max-width: 65%; 
            font-size: 15px; word-break: break-all; position: relative;
        }
        .self .bubble-content { background: #95ec69; margin-right: 10px;
        }
        .friend .bubble-content { background: #fff; margin-left: 10px; border: 0.5px solid #ddd;
        }

        .dock {
            position: absolute;
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            width: 90%; height: 85px;
            background: rgba(255,255,255,0.3); backdrop-filter: blur(20px);
            border-radius: 30px; display: flex; justify-content: space-around; align-items: center;
        }

        /* æ¨¡æ€æ¡†é€šç”¨æ ·å¼ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 3000;
        }
        .modal-box {
            background: #fff; width: 70%; padding: 20px; border-radius: 12px; text-align: center; color: #000;
        }
        
        /* æ¨¡å‹é€‰æ‹©å¼¹çª—æ ·å¼ */
        #model-select-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; display: none;
        }
        #model-select-box {
            position: absolute; width: 80%; max-height: 200px; background: #fff; 
            border: 1px solid #ccc; border-radius: 8px; overflow-y: auto; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            /* ä½ç½®ç”±JSåŠ¨æ€è®¡ç®—ï¼Œæˆ–è€…ç®€å•å±…ä¸­ */
            left: 50%; top: 50%; transform: translate(-50%, -50%);
        }

        /* æ¨¡å‹é€‰æ‹©UIè‡ªå®šä¹‰æ ·å¼ */
        .model-ui-container {
            background: #fdfdfd; width: 100%; border-radius: 10px; padding: 10px; margin: 10px 0; box-sizing: border-box;
            display: flex; flex-direction: column;
        }
        .model-ui-header { font-size: 10px; color: #999; margin-bottom: 5px; text-align: left; }
        .model-ui-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; cursor: pointer; }
        .model-ui-label { font-size: 14px; color: #000; }
        .model-ui-value { font-size: 12px; color: #666; margin-right: 5px; flex: 1; text-align: right; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .model-ui-arrow { font-size: 12px; color: #000; }
        .model-ui-divider { height: 1px; background: #f0f0f0; margin: 5px 0; border: none; width: 100%; }
        .model-ui-btn { 
            border: 1px solid #000; border-radius: 4px; padding: 4px 10px; 
            background: transparent; color: #000; font-size: 14px; margin: 0 auto; display: block; width: fit-content; cursor: pointer;
        }

        /* Chat Settings Styles */
        .settings-container { padding: 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .settings-bubble { background: #fff; border-radius: 12px; overflow: hidden; }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 0.5px solid #f5f5f5; position: relative; cursor: pointer; }
        .settings-row:last-child { border-bottom: none; }
        .settings-row:active { background-color: #f9f9f9; }
        .row-label { font-size: 16px; color: #000; }
        .row-val { font-size: 14px; color: #888; display: flex; align-items: center; }
        .row-arrow { margin-left: 8px; color: #ccc; font-size: 16px; }
        .red-text { color: #fa5151; }

        /* Generic Modal Styles */
        .custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 4000; }
        .custom-modal-box { background: #fff; width: 85%; max-height: 80%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }
        .custom-modal-header { padding: 15px; text-align: center; font-size: 18px; font-weight: bold; border-bottom: 1px solid #eee; }
        .custom-modal-content { flex: 1; overflow-y: auto; padding: 0; }
        .custom-modal-footer { display: flex; border-top: 1px solid #eee; }
        .custom-modal-btn { flex: 1; padding: 15px; text-align: center; font-size: 16px; cursor: pointer; background: #fff; border: none; }
        .custom-modal-btn:active { background: #f5f5f5; }
        .btn-cancel { color: #000; border-right: 1px solid #eee; }
        .btn-confirm { color: #07c160; font-weight: bold; }
        .btn-danger { color: #ff4d4f; font-weight: bold; }
        
        .list-check-item { display: flex; align-items: center; padding: 15px; border-bottom: 0.5px solid #eee; cursor: pointer; }
        .check-circle { width: 22px; height: 22px; border: 1px solid #ccc; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 0; }
        .check-circle.checked { background: #07c160; border-color: #07c160; color: #fff; }
        .check-circle.checked::after { content: 'âœ“'; font-size: 14px; }
        
        .persona-item-img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        
        /* èŠå¤©å†å²åŠ è½½åˆ†å‰²çº¿ */
        .history-divider {
            display: flex; align-items: center; justify-content: center;
            width: 70%; margin: 15px auto;
            color: #999; font-size: 12px;
            flex-shrink: 0;
        }
        .history-divider::before, .history-divider::after {
            content: ''; flex: 1; border-bottom: 1px dashed #ccc;
        }
        .history-divider span {
            padding: 0 10px;
        }

        /* --- Auto Summary & Memory Features CSS --- */
        .auto-summary-bubble {
            background: #fff;
            margin: 10px 15px;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .as-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            font-size: 16px;
        }
        /* Toggle Switch */
        .as-switch {
            width: 50px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        .as-switch.active {
            background: #000;
        }
        .as-switch-handle {
            width: 26px;
            height: 26px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .as-switch.active .as-switch-handle {
            left: 22px;
        }
        
        /* Chat Extension */
        .chat-plus-btn {
            font-size: 28px;
            color: #333;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
        }
        .chat-ext-panel {
            height: 0;
            background: #fff;
            transition: height 0.3s ease;
            overflow: hidden;
            border-top: 1px solid #ddd;
        }
        .chat-ext-panel.open {
            height: 220px; /* Adjust as needed */
        }
        .chat-ext-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            height: 100%;
        }
        .chat-ext-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .chat-ext-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 5px;
            object-fit: contain;
        }
        .chat-ext-text {
            color: gray;
            font-size: 12px;
        }

        /* Memory Screen */
        .memory-list {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .memory-bubble {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .mem-icon-btn {
            position: absolute;
            top: 10px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        .mem-edit-btn { left: 10px; color: #666; }
        .mem-del-btn { right: 10px; color: #ff4d4f; }
        .mem-content {
            margin-top: 20px;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* Summary Popup */
        .summary-content-box {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            font-size: 14px;
            color: #333;
        }

        /* --- Avatar Picker CSS --- */
        .avatar-picker {
            width: 60px; height: 60px; border-radius: 50%;
            border: 2px dashed #999; box-sizing: border-box;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative; cursor: pointer; background: #fff;
        }
        .avatar-picker-plus { font-size: 24px; color: #999; position: absolute; pointer-events: none; }
        .avatar-picker-img { width: 100%; height: 100%; object-fit: cover; display: none; z-index: 2; }
        .avatar-picker.has-img .avatar-picker-img { display: block; }
        .avatar-picker.has-img .avatar-picker-plus { display: none; }

        /* --- Service Page CSS --- */
        .service-bubble-black {
            background: #333; color: #fff; border-radius: 12px;
            padding: 25px; margin: 15px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative;
        }
        .service-balance-label { font-size: 14px; opacity: 0.8; margin-bottom: 15px; }
        .service-pay-icon { font-size: 30px; margin-bottom: 10px; color: #07c160; }
        .service-balance-val { font-size: 36px; font-weight: bold; }
        
        .service-init-box { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .service-init-input { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); 
            color: #fff; padding: 10px; border-radius: 8px; width: 70%; text-align: center; font-size: 20px; outline: none;
        }
        .service-init-tip { font-size: 12px; color: #aaa; margin-top: 8px; }
        .service-init-btn {
            margin-top: 15px; background: #07c160; border: none; color: #fff; 
            padding: 8px 20px; border-radius: 6px; font-size: 14px; cursor: pointer;
        }

        .service-bubble-white {
            background: #fff; border-radius: 12px; margin: 0 15px; padding: 5px 0;
            display: flex; flex-direction: column;
        }
        .service-func-row {
            display: flex; align-items: center; padding: 18px 20px; 
            border-bottom: 0.5px solid #f5f5f5; cursor: pointer;
        }
        .service-func-row:last-child { border-bottom: none; }
        .service-func-icon { width: 24px; height: 24px; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .service-func-text { font-size: 16px; color: #000; flex: 1; }
        .service-func-arrow { color: #ccc; font-size: 18px; }

        /* --- Global Gray-Top White-Bottom Style --- */
        .page-gray-top { background: #ededed; display: flex; flex-direction: column; height: 100%; }
        .page-header-gray { background: #ededed; padding: 50px 15px 15px; display: flex; align-items: center; font-weight: bold; font-size: 17px; color: #000; flex-shrink: 0; }
        .page-content-white { background: #fff; flex: 1; overflow-y: auto; position: relative; }

        /* --- Discovery Page --- */
        #wx-page-discovery { display: none; flex-direction: column; height: 100%; background: #ededed; }
        /* Reuse page-header-gray for discovery header */
        .discovery-item { background: #fff; margin-top: 10px; padding: 15px; display: flex; align-items: center; border-bottom: 0.5px solid #e0e0e0; cursor: pointer; }
        .discovery-icon { width: 24px; height: 24px; margin-right: 15px; }

        /* --- Moments Main Page --- */
        #moments-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 150; display: none; flex-direction: column; color: #000;
        }
/* Top Cover Area */
        .moments-cover-area { position: relative; margin-bottom: 40px; }
        .moments-bg { width: 100%; height: 260px; object-fit: cover; background: #333; }
        .moments-user-info {
            position: absolute; bottom: -20px; right: 20px;
            display: flex; align-items: flex-start; gap: 10px;
        }
        .moments-nick { color: #fff; font-weight: bold; font-size: 18px; margin-top: 15px; text-shadow: 0 1px 1px rgba(0,0,0,0.5); }
        .moments-avatar { width: 70px; height: 70px; border-radius: 8px; border: 2px solid #fff; object-fit: cover; background: #fff; }

        /* Feed Item */
        .moments-item { padding: 15px; border-bottom: 0.5px solid #f0f0f0; display: flex; gap: 10px; }
        .m-avatar { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; flex-shrink: 0; }
        .m-content { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .m-name { color: #576b95; font-weight: bold; font-size: 15px; }
        .m-text { font-size: 15px; color: #000; white-space: pre-wrap; word-break: break-all; }
        .m-image { max-width: 200px; max-height: 200px; object-fit: cover; margin-top: 5px; cursor: pointer; }
        .m-desc-box { background: #f3f3f3; padding: 5px 10px; border-radius: 4px; color: #666; font-size: 12px; align-self: flex-start; margin-top: 5px; }
        .m-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; height: 20px; }
        .m-time { font-size: 12px; color: #999; }
        .m-actions-btn { 
            background: #f7f7f7; color: #576b95; border-radius: 4px; padding: 0 8px; font-weight: bold; cursor: pointer; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; height: 20px;
        }
        
        /* Interaction Menu */
        .m-menu-pop {
            position: absolute; right: 35px; background: #333; border-radius: 4px; 
            display: none; align-items: center; color: #fff; font-size: 13px; z-index: 10;
            padding: 0 5px; height: 32px;
        }
        .m-menu-item { display: flex; align-items: center; padding: 0 12px; cursor: pointer; }
        .m-menu-item:active { background: #444; }
        .m-menu-line { width: 1px; height: 16px; background: #444; }

        /* Like & Comment Area */
        .m-interact-area { background: #f7f7f7; border-radius: 4px; margin-top: 10px; font-size: 13px; display: none; }
        .m-interact-area.show { display: block; }
        .m-likes { padding: 5px 10px; color: #576b95; border-bottom: 0.5px solid #dedede; display: none; align-items: flex-start; }
        .m-likes.show { display: flex; }
        .m-like-icon { margin-right: 5px; font-size: 12px; margin-top: 1px; }
        .m-comments { padding: 5px 10px; display: flex; flex-direction: column; gap: 3px; }
        .m-comment-item { color: #000; }
        .m-c-name { color: #576b95; font-weight: bold; cursor: pointer; }

        /* Publish Modal */
        #pub-moments-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: none; flex-direction: column;
        }
        .pub-input-area { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .pub-text { width: 100%; border: none; font-size: 16px; outline: none; resize: none; min-height: 100px; font-family: inherit; }
        .pub-img-preview-box { width: 80px; height: 80px; position: relative; margin-bottom: 15px; display: none; }
        .pub-img-preview { width: 100%; height: 100%; object-fit: cover; }
        .pub-img-del { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; background: rgba(0,0,0,0.5); color: #fff; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; }
        
        .pub-icons { display: flex; gap: 30px; padding: 10px 0; border-top: 0.5px solid #f0f0f0; }
        .pub-icon-btn { font-size: 24px; cursor: pointer; color: #333; }
        .pub-icon-btn.disabled { color: #ccc; pointer-events: none; }
        
        /* Moments Settings Sidebar */
        #moments-settings-sidebar {
            position: fixed; top: 0; right: -100%; width: 70%; height: 100%; background: #fff; z-index: 2001; 
            box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; display: flex; flex-direction: column;
        }
        #moments-settings-sidebar.open { right: 0; }
        .ms-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; }
        
        /* Comments Input Bar */
        #m-comment-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #f7f7f7; padding: 10px; display: none; align-items: center; z-index: 160;
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); border-top: 0.5px solid #ddd;
        }
        #m-comment-input { flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 8px; font-size: 14px; outline: none; margin-right: 10px; }
        #m-comment-send { background: #07c160; color: #fff; border: none; padding: 6px 15px; border-radius: 4px; font-size: 14px; }

    </style>
</head>
<body>

<div id="splash-screen">
    <div class="star" style="top: 20%; left: 15%; animation-delay: 0s;">â˜…</div>
    <div class="star" style="top: 15%; right: 20%; animation-delay: 0.5s; font-size: 14px;">â˜…</div>
    <div class="star" style="bottom: 40%; left: 10%; animation-delay: 1.2s; font-size: 24px;">â˜…</div>
    <div class="star" style="bottom: 35%; right: 15%; animation-delay: 0.8s;">â˜…</div>
    <div class="star" style="top: 50%; left: 5%; animation-delay: 0.2s; font-size: 12px;">â˜…</div>
    <div class="star" style="top: 45%; right: 8%; animation-delay: 1.5s; font-size: 16px;">â˜…</div>

    <div class="splash-title">
        <span class="title-momo">MoMo</span><span class="title-chat">Chat</span>
    </div>

    <svg class="heart-svg" viewBox="0 0 100 100">
        <path class="heart-path" d="M50 30 C 20 0, 0 30, 50 90 C 100 30, 80 0, 50 30" />
    </svg>

    <div class="splash-footer">æ¬¢è¿ä½¿ç”¨é™Œé™Œå°æ‰‹æœº</div>
</div>

<div id="phone-wrapper">
    <div class="widget-container">
        <div class="widget-item"><div id="widget-date" class="editable" contenteditable="true">--</div><div id="widget-day" class="editable" contenteditable="true">--</div></div>
        <div class="widget-item"><div style="font-size: 10px;">ğŸ“¶ WiFi</div><div style="color:#007aff; font-weight: bold;">On</div></div>
        <div class="widget-item"><div id="widget-time" class="editable" contenteditable="true">--:--</div></div>
        <div class="widget-item"><div style="font-size: 14px;">ğŸ”‹</div><div id="bat-val">--%</div></div>
        <div class="widget-item"><div id="widget-storage" class="editable" contenteditable="true" style="font-size: 9px;">352GB/511GB</div></div>
        <div class="widget-item" style="grid-column: span 2;"><div id="widget-model" class="editable" contenteditable="true">iPhone 16 Pro</div><div id="widget-chip" class="editable" contenteditable="true" style="font-weight:bold;
        font-size: 10px;">ï£¿ A18 Pro</div></div>
        <div class="widget-item"><div id="widget-version" class="editable" contenteditable="true" style="font-size: 9px;">iOS 26.2.1</div></div>
    </div>

    <div class="app-grid">
        <div class="iscreen-img-box" onclick="pickImg('img-left')"><img id="img-left" src="https://via.placeholder.com/300?text=Pic+1"></div>
        <div class="app-item" onclick="openScreen('theme-screen')"><div class="app-icon" style="background:#fff6f9;"><img src="https://files.catbox.moe/acicvj.png" style="width:100%;
        height:100%; border-radius:16px; object-fit:cover;"></div><div style="font-size:12px; color:#fff">ä¸»é¢˜</div></div>
        <div class="app-item" onclick="openWx()"><div class="app-icon" style="background:#fff; overflow:hidden;"><img src="https://files.catbox.moe/p41qzk.png" style="width:100%;
        height:100%; object-fit:cover;"></div><div style="font-size:12px; color:#fff">å¾®ä¿¡</div></div>
        <div class="app-item" onclick="openWorldBook()"><div class="app-icon" style="background:#fff; overflow:hidden;"><img src="https://files.catbox.moe/odkva0.png" style="width:100%; height:100%;
        object-fit:cover;"></div><div style="font-size:12px; color:#fff">ä¸–ç•Œä¹¦</div></div>
        <div class="app-item" onclick="openScreen('settings-screen')"><div class="app-icon" style="background:#fff; overflow:hidden;"><img src="https://files.catbox.moe/87gxcf.png" style="width:100%; height:100%;
        object-fit:cover;"></div><div style="font-size:12px; color:#fff">è®¾ç½®</div></div>
        <div class="app-item"><div class="app-icon" style="background:#fff;overflow:hidden;"><img src="https://files.catbox.moe/jj9fxf.png" style="width:100%; height:100%; object-fit:cover;"></div><div style="font-size:12px;
        color:#fff">å•†åº—</div></div>
        <div class="app-item"><div class="app-icon" style="background:#E0F7FA; color:#fff;">ğ•</div><div style="font-size:12px;
        color:#fff">X</div></div>
        <div class="iscreen-img-box" onclick="pickImg('img-right')"><img id="img-right" src="https://via.placeholder.com/300?text=Pic+2"></div>
    </div>

    <div class="dock">
        <div class="app-icon" style="background:#fff;"><img src="https://files.catbox.moe/b6qyki.png" style="width:80%;"></div>
        <div class="app-icon" style="background:#fff;"><img src="https://files.catbox.moe/e1eq3w.png" style="width:80%;"></div>
        <div class="app-icon" style="background:#fff;"><img src="https://files.catbox.moe/azg53f.png" style="width:80%;"></div>
        <div class="app-icon" style="background:#fff;"><img src="https://files.catbox.moe/2pt67i.png" style="width:80%;"></div>
    </div>

    <div id="wechat-screen" class="screen-full">
        <div id="wx-page-msg" style="display:flex;
        flex-direction:column; height:100%;">
            <div class="sub-header">
                <span class="back-btn" onclick="closeScreen('wechat-screen')">â€¹</span>
                <span style="flex:1;
                text-align:center;">æ¶ˆæ¯</span>
                <span style="font-size:24px;
                cursor:pointer;" onclick="showAddModal('friend')">+</span>
            </div>
            <div id="chat-list" style="flex:1;
            background:#fff; overflow-y:auto;"></div>
        </div>

        <div id="wx-page-discovery" style="display:none; flex-direction:column; height:100%; background:#ededed;">
            <div class="sub-header" style="background:#ededed; border-bottom:0.5px solid #dcdcdc;">
                <span class="back-btn" onclick="closeScreen('wechat-screen')">â€¹</span>
                <span style="flex:1; text-align:center; margin-right:30px;">å‘ç°</span>
            </div>
            <div class="discovery-item" onclick="openMoments()">
                <img src="https://files.catbox.moe/p41qzk.png" class="discovery-icon"> <!-- Reuse WeChat icon or similar as placeholder for Moments -->
                <span style="font-size:16px;">æœ‹å‹åœˆ</span>
                <span style="flex:1;"></span>
                <span style="color:#ccc; font-size:18px;">â€º</span>
            </div>
        </div>
        <div id="wx-page-me" style="display:none;
        flex-direction:column; height:100%; background:#ededed;">
            <div class="sub-header" style="background:#fff;
            padding-bottom:30px;">
                <span class="back-btn" onclick="closeScreen('wechat-screen')">â€¹</span>
                <div id="me-avatar-picker" class="avatar-picker has-img" onclick="pickImg('me-avatar-img')" style="margin-right:15px;">
                    <div class="avatar-picker-plus">+</div>
                    <img id="me-avatar-img" class="avatar-picker-img" src="https://via.placeholder.com/60">
                </div>
                <div style="flex:1">
                    <div id="me-nick-display" style="font-size:20px;
                    font-weight:bold;">æˆ‘</div>
                    <div style="color:#888;
                    font-size:14px; margin-top:4px;">å¾®ä¿¡å·ï¼š<span id="me-id-display">æœªè®¾ç½®</span></div>
                    <div id="me-status-display" style="display:inline-block;
                    border:1px solid #ccc; border-radius:10px; padding:2px 8px; font-size:12px; margin-top:5px; color:#555;">+ çŠ¶æ€</div>
                </div>
            </div>
            <div class="menu-item arrow-r" onclick="openServicePage()">æœåŠ¡</div>
            <div class="menu-item arrow-r" onclick="openMyBios()">æˆ‘çš„äººè®¾</div>
            <div class="menu-item arrow-r" onclick="openMeSettings()">ä¸ªäººä¿¡æ¯è®¾ç½®</div>
            <div class="menu-item arrow-r" onclick="openGlobalSettings()"><div style="display:flex; align-items:center;"><img src="https://files.catbox.moe/87gxcf.png" style="width:20px; height:20px; margin-right:10px; object-fit:cover;">è®¾ç½®</div></div>
        </div>
        <div class="wx-navbar">
            <div class="nav-item" onclick="switchWxTab('msg')"><div class="nav-icon">ğŸ’¬</div>æ¶ˆæ¯</div>
            <div class="nav-item" onclick="switchWxTab('discovery')"><div class="nav-icon">ğŸ§­</div>å‘ç°</div>
            <div class="nav-item" onclick="switchWxTab('me')"><div class="nav-icon">ğŸ‘¤</div>æˆ‘</div>
        </div>
    </div>

    <div id="chat-screen" class="screen-full" style="background:#f3f3f3;">
        <div class="sub-header" style="background:#f3f3f3;
        border-bottom:0.5px solid #ddd;">
            <span class="back-btn" onclick="closeScreen('chat-screen')">â€¹</span>
            <span id="chat-title" style="flex:1;
            text-align:center;">å¥½å‹</span>
            <span onclick="openChatSettings()" style="width:30px; text-align:center; font-size:24px; cursor:pointer;">â‹®</span>
        </div>
        <div id="chat-content" style="flex:1;
        overflow-y:auto; padding:15px; display:flex; flex-direction:column;"></div>
        <div style="background:#f7f7f7; padding:10px; display:flex; align-items:flex-end; gap:8px;
        border-top:0.5px solid #ddd;">
            <div onclick="triggerAiReply()" style="font-size:24px; cursor:pointer;
            padding-bottom:5px;">âš¡</div>
            <textarea id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯..." style="flex:1; min-height:36px; max-height:100px; border:none; border-radius:5px;
            padding:8px; font-size:16px; outline:none; resize:none;"></textarea>
            <div class="chat-plus-btn" onclick="toggleChatPanel()">+</div>
            <button id="msg-send-btn" onclick="sendMessage()" style="display:none; background:#07c160;
            color:#fff; border:none; padding:8px 15px; border-radius:5px; font-weight:bold;">å‘é€</button>
        </div>
        <!-- Chat Extension Panel -->
        <div id="chat-ext-panel" class="chat-ext-panel">
            <div class="chat-ext-grid">
                <div class="chat-ext-item" onclick="openMemoryScreen()">
                    <img src="å¾®ä¿¡å›¾ç‰‡_20260207014330_24_22.png" class="chat-ext-icon" alt="Memory">
                    <span class="chat-ext-text">è®°å¿†</span>
                </div>
                <!-- Other cells empty -->
                <div></div><div></div><div></div>
                <div></div><div></div><div></div><div></div>
            </div>
        </div>
    </div>

    <div id="my-bios-screen" class="screen-full">
        <div class="sub-header">
            <span class="back-btn" onclick="closeScreen('my-bios-screen')">â€¹</span>
            <span style="flex:1;
            text-align:center;">æˆ‘çš„äººè®¾</span>
            <span style="font-size:24px;
            cursor:pointer;" onclick="showAddModal('me')">+</span>
        </div>
        <div id="bios-list" style="flex:1;
        background:#fff; overflow-y:auto;"></div>
    </div>

    <div id="add-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center;
    z-index:2000;">
        <div style="background:#fff; width:80%; padding:20px; border-radius:15px;
        color:#000;">
            <h3 id="modal-title" style="margin-top:0;
            text-align:center;">æ·»åŠ </h3>
            <div style="display:flex; justify-content:center; margin-bottom:15px;">
                <div id="add-head-picker" class="avatar-picker" onclick="document.getElementById('add-head').click()">
                    <div class="avatar-picker-plus">+</div>
                    <img id="add-head-preview" class="avatar-picker-img">
                </div>
            </div>
            <input type="file" id="add-head" accept="image/*" hidden onchange="previewAddHead(this)">
            <input type="text" id="add-nick" placeholder="å§“å/æ˜µç§°" class="input-bubble" style="background:#f5f5f5">
            <input type="text" id="add-mark" placeholder="å¤‡æ³¨" class="input-bubble" style="background:#f5f5f5">
            <textarea id="add-bio" placeholder="è®¾å®šæè¿°" class="input-bubble" style="background:#f5f5f5;
            height:80px;"></textarea>
            <div style="display:flex; justify-content: space-between;
            margin-top:10px;">
                <button onclick="document.getElementById('add-modal').style.display='none'" style="padding:10px 25px;
                border:none; border-radius:8px; background:#eee;">å–æ¶ˆ</button>
                <button onclick="confirmAddAny()" style="background:#07c160;
                color:#fff; border:none; padding:10px 25px; border-radius:8px;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="me-settings-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('me-settings-screen')">â€¹</span><span style="flex:1;
        text-align:center; margin-right:30px;">ä¸ªäººä¿¡æ¯</span></div>
        <div class="setting-box">
            <input type="text" id="set-me-nick" placeholder="æ˜µç§°" class="input-bubble">
            <input type="text" id="set-me-id" placeholder="å¾®ä¿¡å·" class="input-bubble">
            <input type="text" id="set-me-status" placeholder="çŠ¶æ€" class="input-bubble">
            <button onclick="saveMeSettings()" style="width:100%;
            height:50px; background:#07c160; color:#fff; border:none; border-radius:12px; margin-top:20px;">ä¿å­˜</button>
        </div>
    </div>

    <div id="settings-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('settings-screen')">â€¹</span><span style="flex:1;
        text-align:center; margin-right:30px;">è®¾ç½®</span></div>
        
        <div class="menu-item arrow-r" onclick="openScreen('api-screen')">API è®¾ç½®</div>

        <!-- Auto Summary Bubble -->
        <div class="auto-summary-bubble" id="as-bubble">
            <div class="as-row">
                <span>å¼€å¯è‡ªåŠ¨æ€»ç»“</span>
                <div class="as-switch" id="as-switch" onclick="toggleAutoSummary()">
                    <div class="as-switch-handle"></div>
                </div>
            </div>
            <!-- Row 2 injected by JS when active -->
            <div class="as-row" id="as-row-2" style="display:none; border-top: 0.5px solid #eee; padding-top: 10px;">
                <span>è§¦å‘è½®æ•°</span>
                <span id="as-trigger-val" onclick="editTriggerRounds()" style="color:#007aff; cursor:pointer;">25</span>
            </div>
        </div>
    </div>

    <div id="api-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('api-screen')">â€¹</span><span style="flex:1;
        text-align:center; margin-right:30px;">API è®¾ç½®</span></div>
        <div class="setting-box">
            <input type="text" id="api-url" class="input-bubble" placeholder="API åœ°å€">
            <input type="password" id="api-key" class="input-bubble" placeholder="API Key">
            
            <div class="model-ui-container">
                <div class="model-ui-header">æ¨¡å‹é€‰æ‹©</div>
                <div class="model-ui-row" onclick="openModelSelect()">
                    <span class="model-ui-label">æ¨¡å‹åç§°</span>
                    <span id="model-display-val" class="model-ui-value">è¯·å…ˆæ‹‰å–æ¨¡å‹å¹¶é€‰æ‹©</span>
                    <span class="model-ui-arrow">â–¼</span>
                </div>
                <div class="model-ui-divider"></div>
                <button onclick="startFetchModels()" class="model-ui-btn">â–½è·å–æ¨¡å‹åˆ—è¡¨</button>
            </div>

            <input type="number" id="api-memory" class="input-bubble" value="25" placeholder="è®°å¿†æ¡æ•°">
            <button onclick="saveApiSettings()" style="width:100%;
            height:50px; background:#07c160; color:#fff; border:none; border-radius:12px; margin-top:20px;">ä¿å­˜å…¨éƒ¨è®¾ç½®</button>
        </div>
        
        <div id="model-select-overlay" onclick="closeModelSelect(event)">
            <div id="model-select-box">
                </div>
        </div>
    </div>

    <div id="loading-modal" class="modal-overlay">
        <div class="modal-box">
            <p id="loading-text" style="margin-bottom:20px;">æ­£åœ¨è·å–æ¨¡å‹...</p>
            <button id="loading-btn" onclick="closeLoadingModal()" style="padding:8px 20px; border:none; background:#07c160; color:#fff; border-radius:5px; display:none;">ç¡®å®š</button>
        </div>
    </div>

    <div id="theme-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('theme-screen')">â€¹</span><span style="flex:1;
        text-align:center; margin-right:30px;">ä¸»é¢˜è®¾ç½®</span></div>
        <div class="menu-item arrow-r" onclick="openScreen('font-screen')">å­—ä½“è®¾ç½®</div>
        <div class="menu-item arrow-r" onclick="openScreen('wallpaper-screen')">ä¸»å±å¹•å£çº¸</div>
    </div>

    <div id="font-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('font-screen')">â€¹</span><span style="flex:1;
        text-align:center; margin-right:30px;">å­—ä½“è®¾ç½®</span></div>
        <div class="setting-box">
            <input type="text" id="font-url" class="input-bubble" placeholder="å­—ä½“é“¾æ¥">
            <input type="range" id="font-resizer" min="10" max="30" value="14" style="width:100%">
            <input type="color" id="font-color" style="width:50px;
            height:50px;">
            <button onclick="applyFontSettings()" style="width:100%; height:50px; background:#07c160; color:#fff; border:none;
            border-radius:12px;">åº”ç”¨å¹¶ä¿å­˜</button>
        </div>
    </div>

    <div id="wallpaper-screen" class="screen-full">
        <div class="sub-header"><span class="back-btn" onclick="closeScreen('wallpaper-screen')">â€¹</span><span style="flex:1;
        text-align:center; margin-right:30px;">å£çº¸</span></div>
        <div class="setting-box">
            <div class="menu-item arrow-r" onclick="document.getElementById('wall-file').click()">é€‰å–ç›¸å†Œå›¾ç‰‡</div>
            <input type="file" id="wall-file" hidden accept="image/*">
            <div style="display: flex;
            justify-content: space-around; gap: 15px; margin: 20px 0;">
                <div style="text-align: center;">
                    <div id="preview-current" style="width: 100px;
                    height: 180px; background: #ccc; border-radius: 12px; background-size: cover; border: 2px solid #333;"></div>
                    <p style="font-size: 10px;
                    color: #666;">å½“å‰ä½¿ç”¨</p>
                </div>
                <div style="text-align: center;">
                    <div id="preview-new" style="width: 100px;
                    height: 180px; background: #eee; border-radius: 12px; background-size: cover; border: 2px dashed #999; display: flex; align-items: center; justify-content: center; color: #999;
                    font-size: 12px;">æœªé€‰æ‹©</div>
                    <p style="font-size: 10px;
                    color: #666;">å¾…æ›¿æ¢é¢„è§ˆ</p>
                </div>
            </div>
            <button onclick="saveWallpaper()" style="width:100%;
            height:50px; background:#07c160; color:#fff; border:none; border-radius:12px;">ä¿å­˜å¹¶åº”ç”¨</button>
        </div>
    </div>

    <!-- Chat Settings Page -->
    <div id="chat-settings-screen" class="screen-full" style="background:#f3f3f3;">
        <div class="sub-header">
            <span class="back-btn" onclick="closeScreen('chat-settings-screen')">â€¹</span>
            <span style="flex:1; text-align:center; margin-right:30px;">èŠå¤©è®¾ç½®</span>
        </div>
        <div class="settings-container">
            <div class="settings-bubble">
                <div class="settings-row" onclick="openFriendSettings()">
                    <span class="row-label">å¥½å‹ä¸ç¾¤èŠè®¾ç½®</span>
                    <span class="row-arrow">â€º</span>
                </div>
            </div>
            <div class="settings-bubble">
                <div class="settings-row" onclick="openChatBgSettings()">
                    <span class="row-label">èŠå¤©èƒŒæ™¯</span>
                    <span class="row-arrow">â€º</span>
                </div>
            </div>
            <div class="settings-bubble" style="margin-top:auto;">
                <div class="settings-row" onclick="confirmDeleteFriend()" style="justify-content:center;">
                    <span class="row-label red-text" style="color:#ff4d4f;">åˆ é™¤è¯¥å¥½å‹</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Friend Settings Sub-page -->
    <div id="friend-settings-screen" class="screen-full" style="background:#f3f3f3;">
        <div class="sub-header">
            <span class="back-btn" onclick="closeScreen('friend-settings-screen')">â€¹</span>
            <span style="flex:1; text-align:center; margin-right:30px;">å¥½å‹è®¾ç½®</span>
        </div>
        <div class="settings-container">
            <!-- Avatar Area -->
            <div class="settings-bubble" style="padding:20px; display:flex; flex-direction:column; align-items:center;">
                <div id="friend-avatar-picker" class="avatar-picker has-img" onclick="pickImg('setting-friend-avatar')" style="width:80px; height:80px;">
                    <div class="avatar-picker-plus">+</div>
                    <img id="setting-friend-avatar" class="avatar-picker-img" src="">
                </div>
                <div style="font-size:12px; color:#999; margin-top:10px;">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
            </div>

            <!-- Nickname & Remark -->
            <div class="settings-bubble">
                <div class="settings-row" onclick="openEditTextModal('nick')">
                    <span class="row-label">å¥½å‹æ˜µç§°</span>
                    <div class="row-val"><span id="setting-friend-nick">--</span></div>
                </div>
                <div class="settings-row" onclick="openEditTextModal('remark')">
                    <span class="row-label">å¤‡æ³¨</span>
                    <div class="row-val"><span id="setting-friend-remark">æœªè®¾ç½®</span></div>
                </div>
            </div>

            <!-- Role Setting -->
            <div class="settings-bubble" onclick="openEditTextModal('role')">
                <div style="padding:15px;">
                    <div class="row-label" style="margin-bottom:8px;">è§’è‰²è®¾å®š</div>
                    <div id="setting-friend-role" style="font-size:14px; color:#666; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;">--</div>
                </div>
            </div>

            <!-- World Book & Persona -->
            <div class="settings-bubble">
                <div class="settings-row" onclick="openWbSelectModal()">
                    <span class="row-label">ä¸–ç•Œä¹¦</span>
                    <span class="row-val">ç‚¹å‡»é€‰æ‹©â¤</span>
                </div>
                <div class="settings-row" onclick="openPersonaSelectModal()">
                    <span class="row-label">æˆ‘çš„äººè®¾</span>
                    <span class="row-val">ç‚¹å‡»é€‰æ‹©â¤</span>
                </div>
            </div>
            
            <button onclick="saveFriendSettings()" style="width:100%; height:50px; background:#07c160; color:#fff; border:none; border-radius:12px; margin-bottom:20px;">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- Chat Background Screen -->
    <div id="chat-bg-screen" class="screen-full" style="background:#f3f3f3;">
        <div class="sub-header">
             <span class="back-btn" onclick="closeScreen('chat-bg-screen')">â€¹</span>
             <span style="flex:1; text-align:center; margin-right:30px;">èŠå¤©èƒŒæ™¯</span>
        </div>
        <div class="setting-box">
             <div class="settings-bubble">
                 <div class="settings-row" onclick="document.getElementById('chat-bg-file').click()">
                     <span class="row-label">é€‰å–ç›¸å†Œå›¾ç‰‡</span>
                     <span class="row-arrow">â€º</span>
                 </div>
             </div>
             <input type="file" id="chat-bg-file" hidden accept="image/*">
             
             <div style="margin-top:20px;">
                <div style="margin-bottom:10px; color:#666; font-size:12px;">é¢„è§ˆ</div>
                 <div id="chat-bg-preview" style="width:160px; height:284px; background:#ccc; margin:0 auto; border-radius:12px; background-size:cover; border:4px solid #333;"></div>
             </div>

             <button onclick="saveChatBg()" style="width:100%; height:50px; background:#07c160; color:#fff; border:none; border-radius:12px; margin-top:30px;">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- World Book Select Modal -->
    <div id="wb-select-modal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div class="custom-modal-header">ç»‘å®šä¸–ç•Œä¹¦</div>
            <div id="wb-select-list" class="custom-modal-content"></div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn btn-cancel" onclick="document.getElementById('wb-select-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="custom-modal-btn btn-confirm" onclick="confirmWbSelection()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Persona Select Modal -->
    <div id="persona-select-modal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div class="custom-modal-header">ç»™å½“å‰èŠå¤©é€‰æ‹©'æˆ‘'çš„äººè®¾</div>
            <div id="persona-select-list" class="custom-modal-content"></div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn btn-cancel" onclick="document.getElementById('persona-select-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="custom-modal-btn btn-confirm" onclick="confirmPersonaSelection()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Delete Friend Confirm Modal -->
    <div id="del-friend-modal" class="custom-modal-overlay">
        <div class="custom-modal-box" style="width:70%; height:auto;">
            <div style="padding:30px; text-align:center; font-size:16px;">ç¡®å®šè¦åˆ é™¤è¯¥å¥½å‹å—ï¼Ÿ</div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn btn-cancel" onclick="document.getElementById('del-friend-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="custom-modal-btn btn-danger" onclick="executeDeleteFriend()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Edit Text Modal (Reuse for Nickname, Remark, Role) -->
    <div id="edit-text-modal" class="custom-modal-overlay">
        <div class="custom-modal-box" style="width:80%; height:auto;">
            <div id="edit-text-title" class="custom-modal-header">ä¿®æ”¹</div>
            <div style="padding:15px;">
                <textarea id="edit-text-input" class="input-bubble" style="background:#f5f5f5; width:100%; font-family:inherit;"></textarea>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn btn-cancel" onclick="document.getElementById('edit-text-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="custom-modal-btn btn-confirm" onclick="confirmEditText()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-modal" class="modal-overlay">
        <div class="modal-box">
            <p id="toast-msg" style="margin-bottom:20px;">æç¤º</p>
            <button onclick="document.getElementById('toast-modal').style.display='none'" style="padding:8px 20px; border:none; background:#07c160; color:#fff; border-radius:5px;">ç¡®å®š</button>
        </div>
    </div>

    <!-- World Book Main Screen -->
    <div id="worldbook-screen" class="screen-full">
        <div class="sub-header">
            <span class="back-btn" onclick="closeScreen('worldbook-screen')">â€¹</span>
            <span style="flex:1; text-align:center;">ä¸–ç•Œä¹¦</span>
            <span style="font-size:24px; cursor:pointer;" onclick="openEditWorldBook()">+</span>
        </div>
        <div id="worldbook-list" style="flex:1; background:#fff; overflow-y:auto;">
            <!-- List items will be injected here -->
        </div>
    </div>

    <!-- Add/Edit World Book Screen -->
    <div id="worldbook-edit-screen" class="screen-full">
        <div class="sub-header">
            <span class="back-btn" onclick="closeScreen('worldbook-edit-screen')">â€¹</span>
            <span id="wb-edit-title" style="flex:1; text-align:center; margin-right:30px;">æ·»åŠ ä¸–ç•Œä¹¦</span>
            <span onclick="saveWorldBook()" style="color:#07c160; cursor:pointer; font-weight:bold;">ä¿å­˜</span>
        </div>
        <div class="setting-box">
            <div style="font-size:14px; color:#333; margin-top:10px;">æ ‡é¢˜:</div>
            <input type="text" id="wb-title" class="input-bubble" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦æ ‡é¢˜">
            
            <div style="font-size:14px; color:#333; margin-top:10px;">å†…å®¹:</div>
            <textarea id="wb-content" class="input-bubble" style="height:120px; font-family:inherit;" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦å†…å®¹â€¦"></textarea>
            
            <div style="font-size:14px; color:#333; margin-top:10px;">æ³¨å…¥ä½ç½®:</div>
            <select id="wb-position" class="input-bubble" style="background:#fff;">
                <option value="front">å‰</option>
                <option value="middle">ä¸­</option>
                <option value="back">å</option>
            </select>
            
            <div style="font-size:14px; color:#333; margin-top:10px;">åˆ†ç±»:</div>
            <input type="text" id="wb-category" class="input-bubble" placeholder="è¯·è¾“å…¥åˆ†ç±»">
        </div>
    </div>

    <!-- World Book Delete Confirmation Modal -->
    <div id="wb-del-confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <p style="margin-bottom:20px; font-size:16px;">ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¸–ç•Œä¹¦å—ï¼Ÿ</p>
            <div style="display:flex; justify-content:space-around;">
                <button onclick="closeWbDelConfirm()" style="padding:8px 20px; border:none; background:#eee; color:#333; border-radius:5px;">å–æ¶ˆ</button>
                <button onclick="executeDeleteWorldBook()" style="padding:8px 20px; border:none; background:#ff4d4f; color:#fff; border-radius:5px;">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- World Book Delete Success Modal -->
    <div id="wb-del-success-modal" class="modal-overlay">
        <div class="modal-box">
            <p style="margin-bottom:20px; font-size:16px;">å·²æˆåŠŸåˆ é™¤ï¼</p>
            <button onclick="closeWbDelSuccess()" style="padding:8px 20px; border:none; background:#07c160; color:#fff; border-radius:5px;">ç¡®å®š</button>
        </div>
    </div>

    <!-- Memory Screen -->
    <div id="memory-screen" class="screen-full">
        <div class="sub-header">
            <span class="back-btn" onclick="closeScreen('memory-screen')">â€¹</span>
            <span id="memory-screen-title" style="flex:1; text-align:center;">è®°å¿†</span>
            <span onclick="openManualSummary()" style="font-size:20px; cursor:pointer;">âœ</span>
        </div>
        <div id="memory-list" class="memory-list">
            <!-- Memories go here -->
        </div>
    </div>

    <!-- Auto Summary Result Modal -->
    <div id="summary-modal" class="modal-overlay">
        <div class="modal-box" style="width: 80%;">
            <h3 style="margin-top:0;">å¯¹è¯æ€»ç»“</h3>
            <div id="summary-content" class="summary-content-box"></div>
            <div style="display:flex; justify-content: space-between; margin-top:15px;">
                <button onclick="document.getElementById('summary-modal').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:5px; color:#333;">å–æ¶ˆ</button>
                <button onclick="saveSummaryToMemory()" style="padding:8px 20px; border:none; background:#07c160; color:#fff; border-radius:5px;">å­˜å…¥è®°å¿†</button>
            </div>
        </div>
    </div>

    <!-- Edit Memory Modal -->
    <div id="edit-memory-modal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div class="custom-modal-header">ç¼–è¾‘è®°å¿†</div>
            <div style="padding:15px; flex:1;">
                <textarea id="edit-memory-text" class="input-bubble" style="background:#f5f5f5; height:200px; width:100%; font-family:inherit;"></textarea>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn btn-cancel" onclick="document.getElementById('edit-memory-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="custom-modal-btn btn-confirm" onclick="confirmEditMemory()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Delete Memory Confirm Modal -->
    <div id="del-memory-modal" class="modal-overlay">
        <div class="modal-box">
            <p style="margin-bottom:20px; font-size:16px;">ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å¿†å—ï¼Ÿä¼šåœ¨è„‘æµ·ä¸­å½»åº•æ¶ˆå¤±å“¦ã€‚</p>
            <div style="display:flex; justify-content: space-around;">
                <button onclick="document.getElementById('del-memory-modal').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:5px; color:#333;">å–æ¶ˆ</button>
                <button onclick="confirmDeleteMemory()" style="padding:8px 20px; border:none; background:#07c160; color:#fff; border-radius:5px;">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- Manual Summary Modal -->
    <div id="manual-summary-modal" class="modal-overlay">
        <div class="modal-box" style="width:80%;">
            <h3 style="margin-top:0;">æ‰‹åŠ¨ç”Ÿæˆæ€»ç»“</h3>
            <p id="ms-detect-text" style="text-align:left; font-size:14px;">å½“å‰æ£€æµ‹åˆ°Xè½®å¯¹è¯æœªæ€»ç»“</p>
            <p style="text-align:left; font-size:14px; margin-bottom:5px;">è¯·è¾“å…¥æœ¬æ¬¡è¦å¤„ç†çš„è½®æ•°ï¼ˆå°†ä»æœ€æ—©çš„æœªå¤„ç†æ¶ˆæ¯å¼€å§‹ï¼‰ï¼š</p>
            <input type="number" id="ms-round-input" class="input-bubble" style="background:#f5f5f5; text-align:center;">
            <div style="display:flex; justify-content: space-between; margin-top:15px;">
                <button onclick="document.getElementById('manual-summary-modal').style.display='none'" style="padding:8px 20px; border:none; background:#eee; border-radius:5px; color:#333;">å–æ¶ˆ</button>
                <button onclick="executeManualSummary()" style="padding:8px 20px; border:none; background:#07c160; color:#fff; border-radius:5px;">å¼€å§‹æ€»ç»“</button>
            </div>
        </div>
    </div>

    <!-- Service Screen -->
    <div id="service-screen" class="screen-full">
        <div class="sub-header" style="background:#ededed;">
            <span class="back-btn" onclick="closeScreen('service-screen')">â€¹</span>
            <span style="flex:1; text-align:center; margin-right:30px;">æœåŠ¡</span>
        </div>
        
        <div style="flex:1; overflow-y:auto;">
            <!-- Black Balance Bubble -->
            <div class="service-bubble-black">
                <div class="service-balance-label">æˆ‘çš„ä½™é¢</div>
                <div class="service-pay-icon">â‡Œ</div>
                
                <!-- If not initialized -->
                <div id="service-init-section" class="service-init-box" style="display:none;">
                    <input type="number" id="service-init-input" class="service-init-input" placeholder="0.00">
                    <div class="service-init-tip">é¦–æ¬¡è®¾ç½®åä¸å¯æ›´æ”¹</div>
                    <button class="service-init-btn" onclick="confirmInitBalance()">ç¡®è®¤</button>
                </div>
                
                <!-- If initialized -->
                <div id="service-val-section" class="service-balance-val" style="display:none;">Â¥0.00</div>
            </div>

            <!-- White Function Bubble -->
            <div class="service-bubble-white">
                <div class="service-func-row">
                    <div class="service-func-icon" style="color:#07c160;">ğŸ”’</div>
                    <div class="service-func-text">æ”¯ä»˜å¯†ç </div>
                    <div class="service-func-arrow">â€º</div>
                </div>
                <div class="service-func-row">
                    <div class="service-func-icon" style="color:#07c160;">ğŸ›¡ï¸</div>
                    <div class="service-func-text">å…å¯†æ”¯ä»˜</div>
                    <div class="service-func-arrow">â€º</div>
                </div>
                <div class="service-func-row" onclick="openMoneyModal('charge')">
                    <div class="service-func-icon" style="color:#fa9d3b;">ğŸ’°</div>
                    <div class="service-func-text">å……å€¼</div>
                    <div class="service-func-arrow">â€º</div>
                </div>
                <div class="service-func-row" onclick="openMoneyModal('withdraw')">
                    <div class="service-func-icon" style="color:#fa9d3b;">ğŸ’¸</div>
                    <div class="service-func-text">æç°</div>
                    <div class="service-func-arrow">â€º</div>
                </div>
                <div class="service-func-row">
                    <div class="service-func-icon" style="color:#10aeff;">ğŸ’³</div>
                    <div class="service-func-text">äº²å±å¡</div>
                    <div class="service-func-arrow">â€º</div>
                </div>
                <div class="service-func-row">
                    <div class="service-func-icon" style="color:#10aeff;">ğŸ“œ</div>
                    <div class="service-func-text">è´¦å•</div>
                    <div class="service-func-arrow">â€º</div>
                </div>
            </div>
        </div>
    </div>

    <!-- WeChat Global Settings Screen -->
    <div id="wechat-settings-screen" class="screen-full">
        <div class="sub-header">
            <span class="back-btn" onclick="closeScreen('wechat-settings-screen')">â€¹</span>
            <span style="flex:1; text-align:center; margin-right:30px;">è®¾ç½®</span>
        </div>
        <div class="menu-item arrow-r" onclick="openGlobalChatBgSettings()">
             <div style="display:flex; align-items:center;">
                 <span style="font-size:20px; margin-right:10px;">ğŸ–¼ï¸</span>
                 <span>å…¨å±€èŠå¤©èƒŒæ™¯</span>
             </div>
        </div>
    </div>

    <!-- Global Chat Background Screen -->
    <div id="global-chat-bg-screen" class="screen-full" style="background:#f3f3f3;">
        <div class="sub-header">
             <span class="back-btn" onclick="closeScreen('global-chat-bg-screen')">â€¹</span>
             <span style="flex:1; text-align:center; margin-right:30px;">å…¨å±€èŠå¤©å£çº¸</span>
        </div>
        <div class="setting-box">
             <div class="settings-bubble">
                 <div style="padding:15px; font-weight:bold; border-bottom:1px solid #eee;">é€‰æ‹©å…¨å±€èŠå¤©èƒŒæ™¯</div>
                 <div class="settings-row" onclick="document.getElementById('global-chat-bg-file').click()">
                     <span class="row-label">é€‰å–ç›¸å†Œå›¾ç‰‡</span>
                     <span class="row-arrow">â€º</span>
                 </div>
                 <div class="settings-row" onclick="resetGlobalChatBg()">
                     <span class="row-label">æ¢å¤é»˜è®¤èƒŒæ™¯</span>
                     <span class="row-arrow">â€º</span>
                 </div>
             </div>
             <input type="file" id="global-chat-bg-file" hidden accept="image/*">
             
             <div style="margin-top:20px;">
                <div style="margin-bottom:10px; color:#666; font-size:12px;">é¢„è§ˆ</div>
                 <div id="global-chat-bg-preview" style="width:160px; height:284px; background:#ccc; margin:0 auto; border-radius:12px; background-size:cover; border:4px solid #333;"></div>
             </div>

             <button onclick="saveGlobalChatBg()" style="width:100%; height:50px; background:#07c160; color:#fff; border:none; border-radius:12px; margin-top:30px;">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- Money Modal (Charge/Withdraw) -->
    <div id="money-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="money-modal-title" style="margin-top:0;">è¯·è¾“å…¥å……å€¼é‡‘é¢</h3>
            <input type="number" id="money-input" class="input-bubble" style="background:#f5f5f5; text-align:center; font-size:20px;">
            <div style="display:flex; justify-content: space-between; margin-top:15px;">
                <button onclick="document.getElementById('money-modal').style.display='none'" style="padding:10px 25px; border:none; background:#eee; border-radius:5px; color:#333;">å–æ¶ˆ</button>
                <button onclick="executeMoneyAction()" style="padding:10px 25px; border:none; background:#07c160; color:#fff; border-radius:5px;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Moments Screen -->
    <div id="moments-screen" class="page-gray-top">
        <div class="page-header-gray">
            <span class="back-btn" onclick="closeMoments()">â€¹</span>
            <span style="flex:1; text-align:center;">æœ‹å‹åœˆ</span>
            <span class="pub-icon-btn" onclick="openMomentsSettings()" style="margin-right:15px; font-size:20px;">âš™ï¸</span>
            <span class="pub-icon-btn" onclick="openPubModal()" style="font-size:28px; line-height:1;">+</span>
        </div>
        <div class="page-content-white" id="moments-feed">
            <div class="moments-cover-area">
                <img id="moments-bg-img" src="https://via.placeholder.com/600x400/333/666?text=Cover" class="moments-bg" onclick="changeMomentsBg()">
                <div class="moments-user-info">
                    <div class="moments-nick" id="moments-user-nick">æˆ‘</div>
                    <img id="moments-user-avatar" src="https://via.placeholder.com/70" class="moments-avatar">
                </div>
            </div>
            <div id="moments-list">
                <!-- Feed items will be injected here -->
            </div>
        </div>
    </div>

    <!-- Publish Moments Modal -->
    <div id="pub-moments-modal">
        <div class="sub-header" style="background:#fff; border-bottom:0.5px solid #eee;">
            <span onclick="closePubModal()" style="font-size:16px; margin-right:15px; cursor:pointer;">å–æ¶ˆ</span>
            <span style="flex:1; text-align:center; font-weight:bold;">å‘å¸ƒæœ‹å‹åœˆ</span>
            <span onclick="publishMoment()" style="font-size:16px; color:#07c160; font-weight:bold; cursor:pointer;">å‘å¸ƒ</span>
        </div>
        <div class="pub-input-area">
            <textarea id="pub-text" class="input-bubble" placeholder="è¿™ä¸€åˆ»æƒ³æ³•..."></textarea>
            
            <div id="pub-img-box" class="pub-img-preview-box">
                <img id="pub-img-preview" class="pub-img-preview">
                <div class="pub-img-del" onclick="removePubImg()">Ã—</div>
            </div>

            <div class="pub-icons">
                <div class="pub-icon-btn" onclick="document.getElementById('pub-img-input').click()">ğŸ–¼ï¸</div>
                <div class="pub-icon-btn" onclick="openDescModal()">ğŸ“</div>
                <div class="pub-icon-btn" onclick="openPrivacyModal()">ğŸ‘¥</div>
            </div>
            
            <!-- Hidden inputs -->
            <input type="file" id="pub-img-input" hidden accept="image/*" onchange="handlePubImgSelect(this)">
            <input type="hidden" id="pub-desc-data">
            <input type="hidden" id="pub-privacy-data">
            
            <!-- Display selected settings -->
            <div id="pub-desc-preview" style="display:none; background:#f5f5f5; padding:8px; border-radius:4px; font-size:12px; color:#666; position:relative; width:fit-content;">
                <span>æŸ¥çœ‹æè¿°</span>
                <div style="position:absolute; top:-5px; right:-5px; width:16px; height:16px; background:#ccc; border-radius:50%; color:#fff; text-align:center; line-height:16px; cursor:pointer;" onclick="clearPubDesc()">Ã—</div>
            </div>
            <div id="pub-privacy-preview" style="font-size:12px; color:#999; display:none;">
                å¯è§èŒƒå›´: <span id="pub-privacy-text">å…¬å¼€</span>
            </div>
        </div>
    </div>

    <!-- Image Description Modal -->
    <div id="img-desc-modal" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div class="custom-modal-header">å›¾ç‰‡æè¿°</div>
            <div style="padding:15px; text-align:left;">
                <p style="font-size:12px; color:#666; margin-bottom:5px;">è¯·è¾“å…¥ä½ æƒ³ä¸Šä¼ çš„ç”»é¢å†…å®¹</p>
                <textarea id="img-desc-input" class="input-bubble" style="background:#f5f5f5; width:100%; height:80px;" placeholder="ä¾‹å¦‚ï¼šä¸€åªåœ¨çª—å°æ™’å¤ªé˜³çš„å°çŒ«"></textarea>
            </div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn btn-cancel" onclick="document.getElementById('img-desc-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="custom-modal-btn btn-confirm" onclick="saveImgDesc()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div id="privacy-modal" class="custom-modal-overlay">
        <div class="custom-modal-box" style="height:60%;">
            <div class="custom-modal-header">è°å¯ä»¥çœ‹</div>
            <div id="privacy-list" class="custom-modal-content" style="text-align:left;"></div>
            <div class="custom-modal-footer">
                <button class="custom-modal-btn btn-cancel" onclick="document.getElementById('privacy-modal').style.display='none'">å–æ¶ˆ</button>
                <button class="custom-modal-btn btn-confirm" onclick="savePrivacy()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Moments Settings Sidebar -->
    <div id="moments-settings-sidebar">
        <div class="sub-header" style="background:#fff; border-bottom:0.5px solid #eee;">
            <span style="flex:1; font-weight:bold;">æœ‹å‹åœˆè®¾ç½®</span>
            <span style="font-size:24px; cursor:pointer;" onclick="closeMomentsSettings()">Ã—</span>
        </div>
        <div style="padding:15px; flex:1; overflow-y:auto;">
            <div style="font-size:14px; color:#999; margin-bottom:10px;">é€‰æ‹©å¥½å‹ç”Ÿæˆå†…å®¹</div>
            <div id="ms-friend-list"></div>
            <button onclick="generateAiMoments()" style="width:100%; padding:12px; background:#07c160; color:#fff; border:none; border-radius:8px; margin-top:20px;">ç”Ÿæˆæœ‹å‹åœˆå†…å®¹</button>
        </div>
    </div>
    <div id="ms-overlay" class="ms-overlay" onclick="closeMomentsSettings()"></div>

    <!-- Comment Input Bar -->
    <div id="m-comment-bar">
        <input type="text" id="m-comment-input" placeholder="è¯„è®º...">
        <button id="m-comment-send" onclick="sendMomentComment()">å‘é€</button>
    </div>

</div>

<input type="file" id="hidden-picker" style="display:none;" accept="image/*">

<script>
function syncTime() {
    const d = new Date();
    document.getElementById('widget-time').innerText = d.getHours().toString().padStart(2, '0') + ":" + d.getMinutes().toString().padStart(2, '0');
    document.getElementById('widget-date').innerText = (d.getMonth()+1) + "æœˆ" + d.getDate() + "æ—¥";
    const days = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"];
    document.getElementById('widget-day').innerText = days[d.getDay()];
}
setInterval(syncTime, 1000); syncTime();

function openScreen(id) { 
    // æ‰“å¼€è®¾ç½®é¡µé¢æ—¶ï¼Œå›æ˜¾æ•°æ®ä½†ä¸ä¿å­˜
    if(id === 'me-settings-screen') loadMeSettingsUI();
    if(id === 'api-screen') loadApiSettingsUI();
    if(id === 'font-screen') loadFontSettingsUI();
    document.getElementById(id).style.display = 'flex'; 
}
function closeScreen(id) { 
    document.getElementById(id).style.display = 'none'; 
    if(id === 'chat-screen') {
        // é€€å‡ºæ—¶æ¸…ç†æ»šåŠ¨ç›‘å¬
        const chatBox = document.getElementById('chat-content');
        if(chatBox) chatBox.onscroll = null;
    }
}

if (navigator.getBattery) {
    navigator.getBattery().then(bat => {
        const update = 
        () => document.getElementById('bat-val').innerText = Math.floor(bat.level*100) + "%";
        update(); bat.onlevelchange = update;
    });
}

let activeTarget = '';
function pickImg(id) { activeTarget = id; document.getElementById('hidden-picker').click();
}
document.getElementById('hidden-picker').onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const result = ev.target.result;
            const imgEl = document.getElementById(activeTarget);
            if (imgEl) {
                imgEl.src = result;
                // Avatar Picker Logic: If parent is avatar-picker, add has-img class
                if (imgEl.parentElement.classList.contains('avatar-picker')) {
                    imgEl.parentElement.classList.add('has-img');
                }
            }

            if(activeTarget === 'me-avatar-img') { currentUserAvatar = result; localStorage.setItem('me_avatar', result);
            }
            if(activeTarget === 'img-left') localStorage.setItem('img_left', result);
            if(activeTarget === 'img-right') localStorage.setItem('img_right', result);
            // Friend Setting Avatar Temp Update
            if (activeTarget === 'setting-friend-avatar') {
                tempFriendSettings.customAvatar = result;
            }
        }
        reader.readAsDataURL(file);
    }
}

let tempWallpaperData = null;
document.getElementById('wall-file').onchange = function(e) {
    if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            tempWallpaperData = ev.target.result;
            const previewNew = document.getElementById('preview-new');
            if (previewNew) { previewNew.style.backgroundImage = `url(${tempWallpaperData})`; previewNew.innerText = "";
            }
        };
        reader.readAsDataURL(e.target.files[0]);
    }
};
function saveWallpaper() { 
    if (!tempWallpaperData) return alert("è¯·å…ˆé€‰æ‹©ä¸€å¼ æ–°å£çº¸");
    document.documentElement.style.setProperty('--bg-url', `url(${tempWallpaperData})`);
    localStorage.setItem('my_wallpaper', tempWallpaperData);
    const previewCurrent = document.getElementById('preview-current');
    if (previewCurrent) { previewCurrent.style.backgroundImage = `url(${tempWallpaperData})`; previewCurrent.innerText = ""; }
    alert("å£çº¸ä¿å­˜æˆåŠŸï¼"); closeScreen('wallpaper-screen'); 
}

let currentUserAvatar = 'https://via.placeholder.com/60';
let currentUserName = "æˆ‘";
let currentMeId = "wxid_888";
let currentStatus = "å¼€å¿ƒ";
let userBalance = null;
let currentMyBio = "ä½ æ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·ã€‚";
let friends = {}; 
let chatHistory = {};
let myBios = [];
let apiSettings = { url: '', key: '', model: '', memory: 25 };
// æ¶ˆæ¯åŠ è½½çŠ¶æ€ç®¡ç†
let chatLoadedCount = 30;
let isChatLoading = false;

// ä¸´æ—¶å˜é‡ï¼Œç”¨äºAPIè®¾ç½®æœªä¿å­˜æ—¶
let tempApiModels = []; 
let tempSelectedModel = '';

let isAiThinking = false;
function openWx() { openScreen('wechat-screen'); switchWxTab('msg'); }
function switchWxTab(tab) {
    document.getElementById('wx-page-msg').style.display = (tab === 'msg' ? 'flex' : 'none');
    document.getElementById('wx-page-discovery').style.display = (tab === 'discovery' ? 'flex' : 'none');
    document.getElementById('wx-page-me').style.display = (tab === 'me' ? 'flex' : 'none');
}

// ä¸ªäººä¿¡æ¯è®¾ç½®ï¼šåŠ è½½æ—¶ä¸ä¿å­˜ï¼Œåªå›æ˜¾
function openMeSettings() {
    loadMeSettingsUI();
    openScreen('me-settings-screen');
}
function loadMeSettingsUI() {
    document.getElementById('set-me-nick').value = currentUserName;
    document.getElementById('set-me-id').value = currentMeId;
    document.getElementById('set-me-status').value = currentStatus;
}

// ä¸ªäººä¿¡æ¯è®¾ç½®ï¼šç‚¹å‡»ä¿å­˜æ—¶æ‰å†™å…¥
function saveMeSettings() {
    currentUserName = document.getElementById('set-me-nick').value;
    currentMeId = document.getElementById('set-me-id').value;
    currentStatus = document.getElementById('set-me-status').value;
    
    // æ›´æ–°UIæ˜¾ç¤º
    document.getElementById('me-nick-display').innerText = currentUserName;
    document.getElementById('me-id-display').innerText = currentMeId;
    document.getElementById('me-status-display').innerText = currentStatus;
    
    // å†™å…¥æœ¬åœ°å­˜å‚¨
    localStorage.setItem('me_name', currentUserName);
    localStorage.setItem('me_id', currentMeId);
    localStorage.setItem('me_status', currentStatus);
    alert("ä¸ªäººä¿¡æ¯å·²ä¿å­˜");
    closeScreen('me-settings-screen');
}

function openServicePage() {
    openScreen('service-screen');
    if (userBalance === null) {
        document.getElementById('service-init-section').style.display = 'flex';
        document.getElementById('service-val-section').style.display = 'none';
        document.getElementById('service-init-input').value = "";
    } else {
        document.getElementById('service-init-section').style.display = 'none';
        document.getElementById('service-val-section').style.display = 'block';
        document.getElementById('service-val-section').innerText = "Â¥" + parseFloat(userBalance).toFixed(2);
    }
}

function confirmInitBalance() {
    const val = document.getElementById('service-init-input').value;
    if (!val || isNaN(val) || parseFloat(val) < 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
    
    userBalance = parseFloat(val).toFixed(2);
    localStorage.setItem('me_balance', userBalance);
    
    showToast("ä½™é¢åŠ è½½æˆåŠŸ");
    openServicePage(); 
}

let currentMoneyAction = '';
function openMoneyModal(action) {
    if (userBalance === null) return alert("è¯·å…ˆè®¾ç½®åˆå§‹ä½™é¢");
    currentMoneyAction = action;
    document.getElementById('money-modal-title').innerText = action === 'charge' ? "è¯·è¾“å…¥å……å€¼é‡‘é¢" : "è¯·è¾“å…¥æç°é‡‘é¢";
    document.getElementById('money-input').value = "";
    document.getElementById('money-modal').style.display = 'flex';
}

function executeMoneyAction() {
    const val = parseFloat(document.getElementById('money-input').value);
    if (!val || isNaN(val) || val <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");
    
    let current = parseFloat(userBalance);
    if (currentMoneyAction === 'charge') {
        current += val;
    } else {
        if (current < val) return alert("ä½™é¢ä¸è¶³");
        current -= val;
    }
    
    userBalance = current.toFixed(2);
    localStorage.setItem('me_balance', userBalance);
    
    document.getElementById('money-modal').style.display = 'none';
    showToast(currentMoneyAction === 'charge' ? "å……å€¼æˆåŠŸ" : "æç°æˆåŠŸ");
    openServicePage(); 
}

function previewAddHead(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('add-head-preview').src = e.target.result;
            document.getElementById('add-head-picker').classList.add('has-img');
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function openMyBios() { openScreen('my-bios-screen');
}

let modalMode = 'friend'; 
function showAddModal(mode) {
    modalMode = mode;
    document.getElementById('add-modal').style.display = 'flex';
    document.getElementById('modal-title').innerText = mode === 'friend' ? 'æ·»åŠ å¥½å‹' : 'æ·»åŠ æˆ‘çš„äººè®¾';
    document.getElementById('add-mark').style.display = mode === 'friend' ? 'block' : 'none';
}

function confirmAddAny() {
    const nick = document.getElementById('add-nick').value;
    const mark = document.getElementById('add-mark').value;
    const bio = document.getElementById('add-bio').value;
    const headFile = document.getElementById('add-head').files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const avatar = e.target.result;
        if(modalMode === 'friend') {
            const displayName = mark || nick;
            friends[displayName] = { avatar, bio: bio || "æ™®é€šå¥½å‹" };
            chatHistory[displayName] = chatHistory[displayName] || [];
            saveWxData(); renderFriendList();
        } else {
            const newBio = { nick, avatar, bio };
            myBios.push(newBio);
            saveWxData(); renderBioList();
        }
        document.getElementById('add-modal').style.display = 'none';
    };
    if(headFile) reader.readAsDataURL(headFile);
    else reader.onload({target:{result:'https://via.placeholder.com/45'}});
}

function saveWxData() {
    localStorage.setItem('wx_friends', JSON.stringify(friends));
    localStorage.setItem('wx_chat_history', JSON.stringify(chatHistory));
    localStorage.setItem('wx_my_bios', JSON.stringify(myBios));
}

function renderFriendList() {
    const list = document.getElementById('chat-list');
    list.innerHTML = "";
    for(let name in friends) {
        const item = document.createElement('div');
        item.className = 'contact-item';
        item.onclick = () => openChat(name);
        item.innerHTML = `<img src="${friends[name].avatar}" class="contact-avatar"><span>${name}</span>`;
        list.appendChild(item);
    }
}

function renderBioList() {
    const list = document.getElementById('bios-list');
    list.innerHTML = "";
    myBios.forEach((item) => {
        const div = document.createElement('div');
        div.className = 'contact-item';
        div.onclick = () => { currentMyBio = item.bio; alert("å·²åˆ‡æ¢ä¸ºä½ çš„äººè®¾ï¼š" + item.nick); localStorage.setItem('current_my_bio', item.bio); closeScreen('my-bios-screen'); };
        div.innerHTML = `<img src="${item.avatar}" class="contact-avatar"><span>${item.nick}</span>`;
        list.appendChild(div);
    });
}

let currentChatFriend = '';

// è¾…åŠ©ï¼šåˆ›å»ºæ¶ˆæ¯DOM
function createChatRow(text, type, avatar) {
    const row = document.createElement('div');
    row.className = `chat-row ${type === 'self' ? 'self' : 'friend'}`;
    const avatarHtml = `<img src="${avatar}" class="bubble-avatar">`;
    const bubbleHtml = `<div class="bubble-content">${text}</div>`;
    row.innerHTML = type === 'self' ? (bubbleHtml + avatarHtml) : (avatarHtml + bubbleHtml);
    return row;
}

function openChat(name) {
    currentChatFriend = name;
    
    // è®¾ç½®æ ‡é¢˜ (ä¼˜å…ˆä½¿ç”¨å¤‡æ³¨/è‡ªå®šä¹‰æ˜µç§°)
    const f = friends[name];
    const display = f ? (f.customRemark || f.customNick || name) : name;
    document.getElementById('chat-title').innerText = display;
    
    // è®¾ç½®èƒŒæ™¯
    if (f && f.chatBackground) {
        applyChatBackground(f.chatBackground);
    } else {
        applyChatBackground(null);
    }

    // 1. çŠ¶æ€é‡ç½®
    chatLoadedCount = 30;
    isChatLoading = false;
    
    const chatBox = document.getElementById('chat-content');
    chatBox.innerHTML = ""; // æ¸…ç©ºå½“å‰æ˜¾ç¤º
    chatBox.onscroll = null; // å…ˆç§»é™¤æ—§ç›‘å¬
    
    // 2. è·å–æ¶ˆæ¯å¹¶è®¡ç®—åˆ‡ç‰‡
    const allMsgs = chatHistory[name] || [];
    const total = allMsgs.length;
    // å¦‚æœä¸è¶³30æ¡ï¼Œæ˜¾ç¤ºå…¨éƒ¨ï¼›å¦åˆ™æ˜¾ç¤ºæœ€å30æ¡
    const showCount = Math.min(total, chatLoadedCount);
    const startIndex = Math.max(0, total - showCount);
    
    // 3. æ¸²æŸ“è™šçº¿åˆ†éš”çº¿ (å¦‚æœæœ‰æ›´å¤šæ¶ˆæ¯)
    if (total > showCount) {
        const loader = document.createElement('div');
        loader.id = 'chat-history-loader';
        loader.className = 'history-divider';
        loader.innerHTML = '<span>ä¸Šæ»‘åŠ è½½æ›´å¤šè®°å½•</span>';
        chatBox.appendChild(loader);
    }
    
    // 4. æ¸²æŸ“æ¶ˆæ¯
    const msgsToShow = allMsgs.slice(startIndex);
    msgsToShow.forEach(m => {
        const avatar = m.type === 'self' ? currentUserAvatar : (friends[name] ? friends[name].avatar : 'https://via.placeholder.com/40');
        chatBox.appendChild(createChatRow(m.text, m.type, avatar));
    });
    
    openScreen('chat-screen');
    
    // 5. æ»šåŠ¨å®šä½ï¼šå¿…é¡»å®šä½åœ¨æœ€åä¸€æ¡æ¶ˆæ¯
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // 6. ç»‘å®šæ»šåŠ¨ç›‘å¬
    chatBox.onscroll = handleChatScroll;
}

function handleChatScroll() {
    const chatBox = document.getElementById('chat-content');
    if (isChatLoading) return;
    
    // è§¦å‘æ¡ä»¶ï¼šæ»šåŠ¨åˆ°é¡¶éƒ¨é™„è¿‘ (ä¾‹å¦‚å°äº50px) ä¸” è¿˜æœ‰æ›´å¤šæ¶ˆæ¯
    const allMsgs = chatHistory[currentChatFriend] || [];
    if (chatBox.scrollTop < 50 && allMsgs.length > chatLoadedCount) {
        loadMoreMessages();
    }
}

async function loadMoreMessages() {
    if (isChatLoading) return;
    isChatLoading = true;
    
    const loader = document.getElementById('chat-history-loader');
    if (!loader) return;
    
    // æ”¹å˜æ–‡å­—
    loader.querySelector('span').innerText = "æ­£åœ¨åŠ è½½...";
    
    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
    await new Promise(r => setTimeout(r, 600));
    
    const chatBox = document.getElementById('chat-content');
    const allMsgs = chatHistory[currentChatFriend] || [];
    const total = allMsgs.length;
    
    // è®¡ç®—åˆ†é¡µ
    const endIndex = total - chatLoadedCount;
    const startIndex = Math.max(0, endIndex - 30);
    
    const newMsgs = allMsgs.slice(startIndex, endIndex);
    
    if (newMsgs.length > 0) {
        // è®°å½•æ—§é«˜åº¦ï¼Œç”¨äºä¿æŒä½ç½®
        const oldScrollHeight = chatBox.scrollHeight;
        const oldScrollTop = chatBox.scrollTop;
        
        // åˆ›å»ºæ–‡æ¡£ç‰‡æ®µ
        const fragment = document.createDocumentFragment();
        newMsgs.forEach(m => {
            const avatar = m.type === 'self' ? currentUserAvatar : (friends[currentChatFriend] ? friends[currentChatFriend].avatar : '');
            fragment.appendChild(createChatRow(m.text, m.type, avatar));
        });
        
        // æ’å…¥ä½ç½®ï¼šåœ¨ loader ä¹‹å
        if (loader.nextSibling) {
            chatBox.insertBefore(fragment, loader.nextSibling);
        } else {
            chatBox.appendChild(fragment);
        }
        
        // æ›´æ–°çŠ¶æ€
        chatLoadedCount += newMsgs.length;
        
        // ä¿æŒæ»šåŠ¨ä½ç½®
        const newScrollHeight = chatBox.scrollHeight;
        chatBox.scrollTop = (newScrollHeight - oldScrollHeight) + oldScrollTop;
    }
    
    // æ›´æ–° loader çŠ¶æ€
    if (startIndex === 0) {
        loader.remove();
    } else {
        loader.querySelector('span').innerText = "ä¸Šæ»‘åŠ è½½æ›´å¤šè®°å½•";
    }
    
    isChatLoading = false;
}

function renderMessage(text, type) {
    const chatBox = document.getElementById('chat-content');
    
    // æ™ºèƒ½æ»šåŠ¨åˆ¤å®š
    const isAtBottom = (chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight) < 150;
    
    const avatarImg = type === 'self' ? currentUserAvatar : (friends[currentChatFriend] ? friends[currentChatFriend].avatar : '');
    const row = createChatRow(text, type, avatarImg);
    
    chatBox.appendChild(row);
    
    if (type === 'self' || isAtBottom) {
        chatBox.scrollTop = chatBox.scrollHeight;
    }
}

document.getElementById('msg-input').oninput = function() {
    document.getElementById('msg-send-btn').style.display = this.value.trim().length > 0 ? 'block' : 'none';
};
async function sendMessage() {
    const input = document.getElementById('msg-input');
    const content = input.value.trim();
    if(!content) return;
    renderMessage(content, 'self');
    if(!chatHistory[currentChatFriend]) chatHistory[currentChatFriend] = [];
    chatHistory[currentChatFriend].push({text: content, type: 'self'});
    saveWxData();
    input.value = "";
    document.getElementById('msg-send-btn').style.display = 'none';
}

    // --- AI é€»è¾‘ ---
    async function triggerAiReply() {
        if(!apiSettings.key) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API");
        if(isAiThinking) return alert("AI æ­£åœ¨å›å¤ä¸­...");
        isAiThinking = true;
        const originalTitle = document.getElementById('chat-title').innerText;
        const titleDom = document.getElementById('chat-title');
        titleDom.innerText = "æ­£åœ¨è¾“å…¥ä¸­...";
    
        const friendData = friends[currentChatFriend];
        const roleSetting = friendData.customBio || friendData.bio || "æ™®é€šå¥½å‹";
        
        // Persona Logic
        let myPersonaNick = currentUserName;
        let myPersonaBio = currentMyBio;
        if (friendData.boundPersonaId) {
            const boundP = myBios.find(p => p.nick === friendData.boundPersonaId);
            if (boundP) {
                myPersonaNick = boundP.nick;
                myPersonaBio = boundP.bio;
            }
        }

        // World Book Logic
        let wbContent = "";
        if (friendData.boundWorldBooks && friendData.boundWorldBooks.length > 0) {
            const selectedWbs = worldBooks.filter(wb => friendData.boundWorldBooks.includes(wb.id));
            selectedWbs.forEach(wb => {
                 wbContent += `\nã€ä¸–ç•Œä¹¦ï¼š${wb.title}ã€‘\n${wb.content}\n`;
            });
        }
        
        // Memory Logic
        let memoryContent = "";
        const mems = memoryData[currentChatFriend] || [];
        if (mems.length > 0) {
            memoryContent = "\nã€è¿‡å»çš„è®°å¿†ã€‘\n" + mems.map(m => m.text).join("\n") + "\n";
        }

        // é‡æ–°è®¾è®¡çš„ç³»ç»ŸæŒ‡ä»¤
        const systemPrompt = `ä½ ç°åœ¨æ­£åœ¨æ¨¡æ‹Ÿå¾®ä¿¡èŠå¤©ã€‚
ä½ çš„èº«ä»½è®¾å®šï¼š${roleSetting}ã€‚
å¯¹æ–¹èº«ä»½è®¾å®šï¼š${myPersonaBio}ï¼Œåå­—ï¼š${myPersonaNick}ã€‚
${wbContent}
${memoryContent}

ã€å›å¤è§„åˆ™ã€‘
1. ä¸¥ç¦ä½¿ç”¨ä»»ä½•åŠ¨ä½œæè¿°ã€æ—ç™½ã€å†…å¿ƒç‹¬ç™½ï¼ˆå¦‚ï¼š*ç¬‘äº†ç¬‘*ã€(å°´å°¬) ç­‰ï¼‰ã€‚
2. ä½ éœ€è¦æ ¹æ®è¯é¢˜çš„æ·±åº¦å’Œé€»è¾‘ï¼Œã€çµæ´»ã€‘åœ°å›å¤å¤šæ¡çŸ­æ¶ˆæ¯ã€‚
3. å¿…é¡»é€šè¿‡ã€æ¢è¡Œç¬¦ã€‘æ¥åˆ†éš”ä¸åŒçš„æ¶ˆæ¯ï¼Œæ¯ä¸€è¡Œæ–‡å­—éƒ½ä¼šè¢«ç¨‹åºè§£æä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¾®ä¿¡æ°”æ³¡ã€‚
4. æ•°é‡è¦æ±‚ï¼šæ¯æ¬¡å›å¤ã€è‡³å°‘åŒ…å«3ä¸ªç‹¬ç«‹æ°”æ³¡ã€‘ï¼Œä¸Šä¸å°é¡¶ã€‚å¦‚æœè¯é¢˜å¤æ‚æˆ–éœ€è¦å±•å¼€ï¼Œè¯·å‘æ›´å¤šæ°”æ³¡ã€‚
5. æ¨¡æ‹ŸçœŸå®çš„èŠå¤©èŠ‚å¥ï¼Œé•¿è¯çŸ­è¯´ï¼Œåˆ†æ®µå‘é€ï¼Œè®©å¯¹è¯çœ‹èµ·æ¥åƒçœŸå®çš„äººåœ¨æ‰“å­—å‘é€ã€‚`;
    try {
        const context = chatHistory[currentChatFriend].slice(-apiSettings.memory).map(m => ({
            role: m.type === 'self' ? 'user' : 'assistant',
            content: m.text
        }));
        const response = await fetch(`${apiSettings.url}/chat/completions`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiSettings.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: apiSettings.model,
                messages: [{role: "system", content: systemPrompt}, ...context]
            
            })
        });

        const data = await response.json();
        const fullText = data.choices[0].message.content;
        const messages = fullText.split(/[\n]+/).filter(s => s.trim().length > 0);
        for(let i=0; i < messages.length; i++) {
            const msg = messages[i].trim();
            const delay = Math.min(Math.max(msg.length * 120, 1000), 2500);
            await new Promise(res => setTimeout(res, delay));
            
            renderMessage(msg, 'friend');
            chatHistory[currentChatFriend].push({text: msg, type: 'friend'});
            saveWxData();
        }
        
        // Trigger Auto Summary Check
        checkAutoSummary();

    } catch (e) { 
        alert("AI å”¤é†’å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API è®¾ç½®");
    } finally {
        isAiThinking = false;
        titleDom.innerText = originalTitle;
    }
}

// API è®¾ç½®ç›¸å…³é€»è¾‘
function loadApiSettingsUI() {
    document.getElementById('api-url').value = apiSettings.url;
    document.getElementById('api-key').value = apiSettings.key;
    document.getElementById('api-memory').value = apiSettings.memory;
    tempSelectedModel = apiSettings.model;
    updateModelDisplay();
}

function updateModelDisplay() {
    const display = document.getElementById('model-display-val');
    if (tempSelectedModel) {
        display.innerText = tempSelectedModel;
        display.style.color = '#666'; 
        display.style.fontSize = '12px';
    } else {
        display.innerText = 'è¯·å…ˆæ‹‰å–æ¨¡å‹å¹¶é€‰æ‹©';
        display.style.color = '#999';
        display.style.fontSize = '12px';
    }
}

async function startFetchModels() {
    const url = document.getElementById('api-url').value;
    const key = document.getElementById('api-key').value;
    if(!url || !key) return alert("è¯·å…ˆå¡«å†™ API åœ°å€å’Œ Key");

    document.getElementById('loading-modal').style.display = 'flex';
    document.getElementById('loading-text').innerText = "æ­£åœ¨è·å–æ¨¡å‹...";
    document.getElementById('loading-btn').style.display = 'none';

    try {
        const res = await fetch(`${url}/models`, { headers: { 'Authorization': `Bearer ${key}` } });
        const data = await res.json();
        // å¤„ç† data.data å¯èƒ½ä¸º null æˆ– undefined çš„æƒ…å†µ
        const models = data.data || [];
        tempApiModels = models.map(m => m.id);
        
        document.getElementById('loading-text').innerText = `å·²æ‹‰å– ${tempApiModels.length} ä¸ªæ¨¡å‹`;
        const btn = document.getElementById('loading-btn');
        btn.style.display = 'inline-block';
        btn.onclick = function() {
            closeLoadingModal();
            // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œä¸è¦è‡ªåŠ¨å¼¹æ¡†ï¼Œé¿å…å°´å°¬
            if (tempApiModels.length > 0) {
                 // ä¹Ÿå¯ä»¥é€‰æ‹©è¿™é‡Œä¸è‡ªåŠ¨å¼¹ï¼Œè®©ç”¨æˆ·è‡ªå·±ç‚¹è¡Œ
            }
        }
    } catch (e) {
        document.getElementById('loading-text').innerText = "è·å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®";
        const btn = document.getElementById('loading-btn');
        btn.style.display = 'inline-block';
        btn.onclick = closeLoadingModal;
    }
}

function closeLoadingModal() {
    document.getElementById('loading-modal').style.display = 'none';
}

function openModelSelect() {
    if(!tempApiModels || tempApiModels.length === 0) {
        // å¦‚æœæ²¡æœ‰æ¨¡å‹ï¼Œæç¤ºå»æ‹‰å–
        return alert("è¯·å…ˆç‚¹å‡»ä¸‹æ–¹çš„è·å–æ¨¡å‹åˆ—è¡¨");
    }
    const box = document.getElementById('model-select-box');
    box.innerHTML = '';
    tempApiModels.forEach(m => {
        const item = document.createElement('div');
        item.style = "padding:12px; border-bottom:1px solid #eee; font-size:14px;";
        item.innerText = m;
        item.onclick = (e) => {
            e.stopPropagation(); // é˜²æ­¢å†’æ³¡å…³é—­
            tempSelectedModel = m;
            updateModelDisplay();
            document.getElementById('model-select-overlay').style.display = 'none';
        };
        box.appendChild(item);
    });
    document.getElementById('model-select-overlay').style.display = 'block';
}

function closeModelSelect(e) {
    // ç‚¹å‡»é®ç½©å±‚å…³é—­ï¼Œç‚¹å‡»å†…éƒ¨ä¸å…³é—­ï¼ˆé€šè¿‡stopPropagationå¤„ç†äº†ï¼‰
    if(e.target.id === 'model-select-overlay') {
        document.getElementById('model-select-overlay').style.display = 'none';
    }
}

function saveApiSettings() {
    apiSettings.url = document.getElementById('api-url').value;
    apiSettings.key = document.getElementById('api-key').value;
    apiSettings.memory = parseInt(document.getElementById('api-memory').value) || 25;
    apiSettings.model = tempSelectedModel;

    localStorage.setItem('my_api_url', apiSettings.url);
    localStorage.setItem('my_api_key', apiSettings.key);
    localStorage.setItem('my_api_model', apiSettings.model);
    localStorage.setItem('my_api_memory', apiSettings.memory);
    alert("API è®¾ç½®å·²ä¿å­˜"); 
    closeScreen('api-screen');
}

// å­—ä½“è®¾ç½®ç›¸å…³é€»è¾‘
function loadFontSettingsUI() {
    // è¿™é‡Œæ²¡æœ‰å­˜ä¸´æ—¶å˜é‡ï¼Œç›´æ¥è¯» computed style æˆ–è€… localStorage ä¹Ÿå¯ä»¥
    // ç®€åŒ–å¤„ç†ï¼šç›´æ¥è¯»å– current settings
    // å®é™…åº”è¯¥è¯»å– input çš„å€¼ï¼Œå¦‚æœæœªä¿å­˜åˆ™é‡ç½®
    // ç”±äºä¹‹å‰æ²¡æœ‰ä¸“é—¨å­˜ input value åˆ° localstorageï¼Œè¿™é‡Œä¸å›æ˜¾ input valueï¼Œ
    // è€Œæ˜¯å›æ˜¾å½“å‰ç”Ÿæ•ˆçš„å€¼
    // ä½†ä¸ºäº†ç¬¦åˆâ€œä¸ç‚¹å‡»ä¿å­˜ä¸ç”Ÿæ•ˆâ€çš„é€»è¾‘ï¼Œæˆ‘ä»¬å‡è®¾ç”¨æˆ·å¯èƒ½æƒ³çœ‹åˆ°ä¸Šæ¬¡ä¿å­˜çš„å€¼ã€‚
    // ç”±äºæ²¡æœ‰é¢å¤–å­˜å‚¨ï¼Œè¿™é‡Œä¸åšå¤æ‚å›æ˜¾é€»è¾‘ï¼Œä»…é‡ç½®ã€‚
}

function applyFontSettings() {
    const size = document.getElementById('font-resizer').value + "px";
    const color = document.getElementById('font-color').value;
    const fontUrl = document.getElementById('font-url').value; // å‡è®¾æ”¯æŒå­—ä½“URLï¼Œè™½æœªå®ç°åŠ è½½é€»è¾‘
    
    // åªæœ‰ç‚¹å‡»ä¿å­˜æ—¶æ‰åº”ç”¨æ ·å¼
    document.documentElement.style.setProperty('--main-font-size', size);
    document.documentElement.style.setProperty('--main-font-color', color);
    
    localStorage.setItem('font_size', size); 
    localStorage.setItem('font_color', color);
    // å­—ä½“URLé€»è¾‘æš‚æœªå®ç°cssæ³¨å…¥ï¼Œä»…ä¿å­˜
    if(fontUrl) localStorage.setItem('font_url', fontUrl);

    alert("å­—ä½“è®¾ç½®å·²ä¿å­˜");
    closeScreen('font-screen');
}

// --- World Book Logic Start ---
let worldBooks = [];
let currentWbId = null; // For editing
let pendingWbDelId = null; // For deletion

function openWorldBook() {
    openScreen('worldbook-screen');
    renderWorldBookList();
}

function renderWorldBookList() {
    const list = document.getElementById('worldbook-list');
    list.innerHTML = "";
    
    if (worldBooks.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æš‚æ— ä¸–ç•Œä¹¦æ¡ç›®</div>';
        return;
    }

    worldBooks.forEach(wb => {
        const item = document.createElement('div');
        item.className = 'menu-item'; // Reuse existing style for list items
        item.style.justifyContent = 'space-between';
        
        // Title area (clickable to edit)
        const titleSpan = document.createElement('span');
        titleSpan.innerText = wb.title;
        titleSpan.style.flex = '1';
        titleSpan.style.cursor = 'pointer';
        titleSpan.onclick = () => openEditWorldBook(wb.id);
        
        // Delete icon
        const delIcon = document.createElement('span');
        delIcon.innerText = 'ğŸ—‘ï¸'; 
        delIcon.style.padding = '10px';
        delIcon.style.cursor = 'pointer';
        delIcon.onclick = (e) => {
            e.stopPropagation(); // Prevent triggering edit
            confirmDeleteWorldBook(wb.id);
        };

        item.appendChild(titleSpan);
        item.appendChild(delIcon);
        list.appendChild(item);
    });
}

function openEditWorldBook(id = null) {
    currentWbId = id;
    const titleDom = document.getElementById('wb-edit-title');
    const titleInput = document.getElementById('wb-title');
    const contentInput = document.getElementById('wb-content');
    const posInput = document.getElementById('wb-position');
    const catInput = document.getElementById('wb-category');

    if (id) {
        // Edit Mode
        titleDom.innerText = "ç¼–è¾‘ä¸–ç•Œä¹¦";
        const wb = worldBooks.find(b => b.id === id);
        if (wb) {
            titleInput.value = wb.title;
            contentInput.value = wb.content;
            posInput.value = wb.injectionPosition;
            catInput.value = wb.category;
        }
    } else {
        // Add Mode
        titleDom.innerText = "æ·»åŠ ä¸–ç•Œä¹¦";
        titleInput.value = "";
        contentInput.value = "";
        posInput.value = "front"; // Default
        catInput.value = "";
    }
    openScreen('worldbook-edit-screen');
}

function saveWorldBook() {
    const title = document.getElementById('wb-title').value.trim();
    const content = document.getElementById('wb-content').value.trim();
    const position = document.getElementById('wb-position').value;
    const category = document.getElementById('wb-category').value.trim();

    if (!title) {
        alert("è¯·è¾“å…¥æ ‡é¢˜");
        return;
    }

    const now = new Date().toISOString();

    if (currentWbId) {
        // Update
        const index = worldBooks.findIndex(b => b.id === currentWbId);
        if (index !== -1) {
            worldBooks[index].title = title;
            worldBooks[index].content = content;
            worldBooks[index].injectionPosition = position;
            worldBooks[index].category = category;
            worldBooks[index].updatedAt = now;
        }
    } else {
        // Create
        const newWb = {
            id: 'wb_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            title: title,
            content: content,
            injectionPosition: position,
            category: category,
            createdAt: now,
            updatedAt: now
        };
        worldBooks.push(newWb);
    }

    saveWorldBooksData();
    closeScreen('worldbook-edit-screen');
    renderWorldBookList();
}

function saveWorldBooksData() {
    localStorage.setItem('world_books', JSON.stringify(worldBooks));
}

// Delete Flow
function confirmDeleteWorldBook(id) {
    pendingWbDelId = id;
    document.getElementById('wb-del-confirm-modal').style.display = 'flex';
}

function closeWbDelConfirm() {
    document.getElementById('wb-del-confirm-modal').style.display = 'none';
    pendingWbDelId = null;
}

function executeDeleteWorldBook() {
    if (pendingWbDelId) {
        worldBooks = worldBooks.filter(b => b.id !== pendingWbDelId);
        saveWorldBooksData();
        closeWbDelConfirm();
        document.getElementById('wb-del-success-modal').style.display = 'flex';
    }
}

function closeWbDelSuccess() {
    document.getElementById('wb-del-success-modal').style.display = 'none';
    renderWorldBookList();
}
// --- World Book Logic End ---

document.querySelectorAll('.editable').forEach(el => {
    el.addEventListener('blur', () => { localStorage.setItem('widget_' + el.id, el.innerText); });
});
window.onload = function() {
    const s_url = localStorage.getItem('my_api_url');
    const s_key = localStorage.getItem('my_api_key');
    const s_model = localStorage.getItem('my_api_model');
    const s_memory = localStorage.getItem('my_api_memory');
    const s_wall = localStorage.getItem('my_wallpaper');
    const s_name = localStorage.getItem('me_name');
    const s_id = localStorage.getItem('me_id');
    const s_status = localStorage.getItem('me_status');
    const s_avatar = localStorage.getItem('me_avatar');
    const s_balance = localStorage.getItem('me_balance');
    const s_f = localStorage.getItem('wx_friends');
    const s_ch = localStorage.getItem('wx_chat_history');
    const s_bios = localStorage.getItem('wx_my_bios');
    const s_cur_bio = localStorage.getItem('current_my_bio');
    const s_fs = localStorage.getItem('font_size');
    const s_fc = localStorage.getItem('font_color');
    const s_imgl = localStorage.getItem('img_left');
    const s_imgr = localStorage.getItem('img_right');

    if(s_url) { apiSettings.url = s_url; }
    if(s_key) { apiSettings.key = s_key; }
    if(s_model) { apiSettings.model = s_model; }
    if(s_memory) { apiSettings.memory = parseInt(s_memory); }
    
    if(s_wall) {
        document.documentElement.style.setProperty('--bg-url', `url(${s_wall})`);
        const pCur = document.getElementById('preview-current');
        if(pCur) { pCur.style.backgroundImage = `url(${s_wall})`; }
    }
    if(s_name) { currentUserName = s_name; document.getElementById('me-nick-display').innerText = s_name; }
    if(s_id) { currentMeId = s_id; document.getElementById('me-id-display').innerText = s_id; }
    if(s_status) { currentStatus = s_status; document.getElementById('me-status-display').innerText = s_status; }
    
    if(s_avatar) { 
        currentUserAvatar = s_avatar; 
        const el = document.getElementById('me-avatar-img');
        el.src = s_avatar;
        el.parentElement.classList.add('has-img');
    }
    if(s_balance) userBalance = s_balance;
    if(s_f) { friends = JSON.parse(s_f); renderFriendList(); }
    if(s_ch) chatHistory = JSON.parse(s_ch);
    if(s_bios) { myBios = JSON.parse(s_bios); renderBioList(); }
    if(s_cur_bio) currentMyBio = s_cur_bio;
    if(s_fs) document.documentElement.style.setProperty('--main-font-size', s_fs);
    if(s_fc) document.documentElement.style.setProperty('--main-font-color', s_fc);
    if(s_imgl) document.getElementById('img-left').src = s_imgl;
    if(s_imgr) document.getElementById('img-right').src = s_imgr;

    const s_wb = localStorage.getItem('world_books');
    if(s_wb) { worldBooks = JSON.parse(s_wb); }

    document.querySelectorAll('.editable').forEach(el => {
        const saved = localStorage.getItem('widget_' + el.id);
        if(saved) el.innerText = saved;
    });

    // --- æ•°æ®åŠ è½½å®Œæˆï¼Œå…³é—­å¼€å±åŠ¨ç”» ---
    setTimeout(function() {
        var splash = document.getElementById('splash-screen');
        if (splash) {
            splash.style.transition = 'opacity 0.5s ease-out';
            splash.style.opacity = '0';
            setTimeout(function() {
                splash.style.display = 'none';
            }, 500);
        }
    }, 1500); // å»¶è¿Ÿ 1.5 ç§’ä»¥ä¾¿ç”¨æˆ·çœ‹åˆ°åŠ¨ç”»
};

// --- New Features JS ---

// 1. Chat Settings Entry
function openChatSettings() {
    openScreen('chat-settings-screen');
}

// 2. Friend Settings Logic
let tempFriendSettings = {};
let editTargetKey = '';

function openFriendSettings() {
    // Clone current friend data to temp
    const f = friends[currentChatFriend];
    tempFriendSettings = JSON.parse(JSON.stringify(f));
    // Ensure fields exist
    tempFriendSettings.customNick = tempFriendSettings.customNick || currentChatFriend; // Default to key
    tempFriendSettings.customRemark = tempFriendSettings.customRemark || "";
    tempFriendSettings.customBio = tempFriendSettings.customBio || tempFriendSettings.bio;
    tempFriendSettings.boundWorldBooks = tempFriendSettings.boundWorldBooks || [];
    tempFriendSettings.boundPersonaId = tempFriendSettings.boundPersonaId || "";
    
    // UI Update
    const sfa = document.getElementById('setting-friend-avatar');
    sfa.src = tempFriendSettings.customAvatar || tempFriendSettings.avatar;
    if(sfa.src && sfa.src !== window.location.href) sfa.parentElement.classList.add('has-img');
    
    document.getElementById('setting-friend-nick').innerText = tempFriendSettings.customNick;
    document.getElementById('setting-friend-remark').innerText = tempFriendSettings.customRemark || "æœªè®¾ç½®";
    document.getElementById('setting-friend-role').innerText = tempFriendSettings.customBio;
    
    openScreen('friend-settings-screen');
}

// Avatar pick override logic is handled in global onchange now
// Removed duplicate listener

function openEditTextModal(key) {
    editTargetKey = key;
    const modal = document.getElementById('edit-text-modal');
    const input = document.getElementById('edit-text-input');
    const title = document.getElementById('edit-text-title');
    
    modal.style.display = 'flex';
    input.value = "";
    
    if (key === 'nick') {
        title.innerText = "ä¿®æ”¹å¥½å‹æ˜µç§°";
        input.value = tempFriendSettings.customNick;
    } else if (key === 'remark') {
        title.innerText = "ä¿®æ”¹å¤‡æ³¨";
        input.value = tempFriendSettings.customRemark;
    } else if (key === 'role') {
        title.innerText = "ä¿®æ”¹è§’è‰²è®¾å®š";
        input.value = tempFriendSettings.customBio;
        input.style.height = "150px";
    } else {
        input.style.height = "auto";
    }
}

function confirmEditText() {
    const val = document.getElementById('edit-text-input').value.trim();
    if (editTargetKey === 'nick') {
        if(!val) return alert("æ˜µç§°ä¸èƒ½ä¸ºç©º");
        tempFriendSettings.customNick = val;
        document.getElementById('setting-friend-nick').innerText = val;
    } else if (editTargetKey === 'remark') {
        tempFriendSettings.customRemark = val;
        document.getElementById('setting-friend-remark').innerText = val || "æœªè®¾ç½®";
    } else if (editTargetKey === 'role') {
        if(!val) return alert("è§’è‰²è®¾å®šä¸èƒ½ä¸ºç©º");
        tempFriendSettings.customBio = val;
        document.getElementById('setting-friend-role').innerText = val;
    }
    document.getElementById('edit-text-modal').style.display = 'none';
}

function saveFriendSettings() {
    // Apply temp to real
    const f = friends[currentChatFriend];
    f.avatar = tempFriendSettings.customAvatar || f.avatar; // Update main avatar? Requirement: "Click change avatar". Yes.
    // Also save custom fields
    f.customAvatar = tempFriendSettings.customAvatar;
    f.customNick = tempFriendSettings.customNick;
    f.customRemark = tempFriendSettings.customRemark;
    f.customBio = tempFriendSettings.customBio;
    f.boundWorldBooks = tempFriendSettings.boundWorldBooks;
    f.boundPersonaId = tempFriendSettings.boundPersonaId;
    
    // Sync basic fields for compatibility
    f.bio = f.customBio;
    
    // Save to storage
    friends[currentChatFriend] = f;
    saveWxData();
    
    // Show Toast
    closeScreen('friend-settings-screen');
    showToast("è®¾ç½®å·²ä¿å­˜");
    
    // Update Chat UI if needed (Avatar/Title)
    // If remark changed, title should update? 
    // The chat screen title is set on openChat. If we return to chat screen, we might want to refresh title.
    const displayName = f.customRemark || f.customNick || currentChatFriend;
    document.getElementById('chat-title').innerText = displayName;
    // Also update avatar in chat history? Chat history stores "self/friend". Avatar is rendered dynamically from friends[name].avatar.
    // So refreshing chat isn't strictly needed unless we want to see immediate change, but we are back in Chat Settings screen.
    // When user goes back to Chat Screen, the avatar will be used for NEW messages. Existing DOM messages use img src.
    // To be perfect, we should refresh chat content.
    const chatContent = document.getElementById('chat-content');
    if (chatContent) {
        // Simple re-render
        chatContent.innerHTML = "";
        (chatHistory[currentChatFriend] || []).forEach(m => renderMessage(m.text, m.type));
    }
}

function showToast(msg) {
    document.getElementById('toast-msg').innerText = msg;
    document.getElementById('toast-modal').style.display = 'flex';
}

// 3. World Book Select Logic
function openWbSelectModal() {
    const list = document.getElementById('wb-select-list');
    list.innerHTML = "";
    const currentSel = tempFriendSettings.boundWorldBooks || [];
    
    if (worldBooks.length === 0) {
        list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">æš‚æ— ä¸–ç•Œä¹¦</div>';
    } else {
        worldBooks.forEach(wb => {
            const item = document.createElement('div');
            item.className = "list-check-item";
            const isChecked = currentSel.includes(wb.id);
            item.innerHTML = `<div class="check-circle ${isChecked ? 'checked' : ''}" data-id="${wb.id}"></div><span>${wb.title}</span>`;
            item.onclick = function() {
                const circle = this.querySelector('.check-circle');
                circle.classList.toggle('checked');
            };
            list.appendChild(item);
        });
    }
    document.getElementById('wb-select-modal').style.display = 'flex';
}

function confirmWbSelection() {
    const selected = [];
    document.querySelectorAll('#wb-select-list .check-circle.checked').forEach(el => {
        selected.push(el.getAttribute('data-id'));
    });
    tempFriendSettings.boundWorldBooks = selected;
    document.getElementById('wb-select-modal').style.display = 'none';
}

// 4. Persona Select Logic
function openPersonaSelectModal() {
    const list = document.getElementById('persona-select-list');
    list.innerHTML = "";
    // Default select logic: If empty, select first
    let currentSelId = tempFriendSettings.boundPersonaId;
    if (!currentSelId && myBios.length > 0) {
        currentSelId = myBios[0].nick; // Use nick as ID for now
    }
    
    if (myBios.length === 0) {
        list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">æš‚æ— "æˆ‘"çš„äººè®¾</div>';
    } else {
        myBios.forEach(p => {
            const item = document.createElement('div');
            item.className = "list-check-item";
            const isChecked = (p.nick === currentSelId);
            item.innerHTML = `<img src="${p.avatar}" class="persona-item-img">
                              <span style="flex:1">${p.nick}</span>
                              <div class="check-circle ${isChecked ? 'checked' : ''}" style="margin-right:0; margin-left:10px;"></div>`;
            item.onclick = function() {
                // Radio logic
                document.querySelectorAll('#persona-select-list .check-circle').forEach(c => c.classList.remove('checked'));
                this.querySelector('.check-circle').classList.add('checked');
                currentSelId = p.nick;
            };
            list.appendChild(item);
        });
    }
    // Store temporarily on the list element or closure? 
    // Better to read DOM on confirm
    list.setAttribute('data-temp-sel', currentSelId || "");
    
    document.getElementById('persona-select-modal').style.display = 'flex';
}

function confirmPersonaSelection() {
    // Find checked one
    let selectedId = "";
    const checked = document.querySelector('#persona-select-list .check-circle.checked');
    if (checked) {
        // Find parent, get nick? 
        // Logic: I iterated myBios. The check-circle doesn't store ID in DOM in my loop above.
        // Let's rely on the DOM structure: sibling span has nick.
        const parent = checked.parentElement;
        selectedId = parent.querySelector('span').innerText;
    }
    
    // If nothing checked (empty list), selectedId is empty
    tempFriendSettings.boundPersonaId = selectedId;
    document.getElementById('persona-select-modal').style.display = 'none';
}

// 5. Chat Background Logic
let tempChatBg = null;
function openChatBgSettings() {
    tempChatBg = null;
    document.getElementById('chat-bg-preview').style.backgroundImage = 'none';
    document.getElementById('chat-bg-preview').innerText = "æœªé€‰æ‹©";
    openScreen('chat-bg-screen');
}

document.getElementById('chat-bg-file').addEventListener('change', function(e) {
    if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            tempChatBg = ev.target.result;
            const p = document.getElementById('chat-bg-preview');
            p.style.backgroundImage = `url(${tempChatBg})`;
            p.innerText = "";
        };
        reader.readAsDataURL(e.target.files[0]);
    }
});

function saveChatBg() {
    if (!tempChatBg) return alert("è¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼Œæˆ–ç›´æ¥è¿”å›ä¸ä¿å­˜");
    const f = friends[currentChatFriend];
    f.chatBackground = tempChatBg;
    friends[currentChatFriend] = f;
    saveWxData();
    
    // Apply immediately to Chat Screen? 
    // We need to update Chat Screen logic to load this background
    applyChatBackground(tempChatBg);
    
    closeScreen('chat-bg-screen');
    showToast("ä¿å­˜æˆåŠŸ");
}

function applyChatBackground(bgUrl) {
    const chatScreen = document.getElementById('chat-content'); 
    const screen = document.getElementById('chat-screen');
    
    let finalBg = bgUrl;
    if (!finalBg) {
        finalBg = localStorage.getItem('global_chat_bg');
    }
    
    if (finalBg) {
        screen.style.background = `url(${finalBg}) center/cover no-repeat`;
    } else {
        screen.style.background = '#f3f3f3';
    }
}

// (åŸ openChat é‡å†™é€»è¾‘å·²åˆå¹¶è‡³ä¸»å‡½æ•°ï¼Œæ­¤å¤„ç§»é™¤ä»¥é¿å…å†²çª)

// --- Global Settings Logic ---
function openGlobalSettings() {
    openScreen('wechat-settings-screen');
}

let tempGlobalChatBg = null;
function openGlobalChatBgSettings() {
    tempGlobalChatBg = null;
    const currentGlobal = localStorage.getItem('global_chat_bg');
    const p = document.getElementById('global-chat-bg-preview');
    if(currentGlobal) {
        p.style.backgroundImage = `url(${currentGlobal})`;
        p.innerText = "";
    } else {
        p.style.backgroundImage = 'none';
        p.innerText = "é»˜è®¤èƒŒæ™¯";
    }
    openScreen('global-chat-bg-screen');
}

document.getElementById('global-chat-bg-file').addEventListener('change', function(e) {
    if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            tempGlobalChatBg = ev.target.result;
            const p = document.getElementById('global-chat-bg-preview');
            p.style.backgroundImage = `url(${tempGlobalChatBg})`;
            p.innerText = "";
        };
        reader.readAsDataURL(e.target.files[0]);
    }
});

function saveGlobalChatBg() {
    if (tempGlobalChatBg) {
        localStorage.setItem('global_chat_bg', tempGlobalChatBg);
        alert("å…¨å±€èƒŒæ™¯å·²ä¿å­˜");
    } else {
        alert("æœªé€‰æ‹©æ–°å›¾ç‰‡ï¼Œå¦‚éœ€æ¸…é™¤è¯·ç‚¹å‡»æ¢å¤é»˜è®¤");
    }
    closeScreen('global-chat-bg-screen');
}

function resetGlobalChatBg() {
    localStorage.removeItem('global_chat_bg');
    tempGlobalChatBg = null;
    document.getElementById('global-chat-bg-preview').style.backgroundImage = 'none';
    document.getElementById('global-chat-bg-preview').innerText = "é»˜è®¤èƒŒæ™¯";
    alert("å·²æ¢å¤é»˜è®¤å…¨å±€èƒŒæ™¯");
}

// 6. Delete Friend Logic
function confirmDeleteFriend() {
    document.getElementById('del-friend-modal').style.display = 'flex';
}

function executeDeleteFriend() {
    // Delete data
    delete friends[currentChatFriend];
    delete chatHistory[currentChatFriend];
    saveWxData();
    
    // Close modals
    document.getElementById('del-friend-modal').style.display = 'none';
    closeScreen('chat-settings-screen');
    closeScreen('chat-screen');
    
    // Show toast and refresh list
    showToast("åˆ é™¤æˆåŠŸ");
    renderFriendList();
}

// --- Auto Summary & Memory Features JS ---

let autoSummaryEnabled = false;
let autoSummaryTriggerRounds = 25;
let memoryData = {}; // { friendName: [ {id, text, time} ] }
let summaryStatus = {}; // { friendName: { lastIndex: 0 } }

// Load Settings
function loadAutoSummarySettings() {
    const enabled = localStorage.getItem('as_enabled');
    const rounds = localStorage.getItem('as_rounds');
    const mems = localStorage.getItem('wx_memories');
    const status = localStorage.getItem('as_status');

    if (enabled === 'true') {
        autoSummaryEnabled = true;
        document.getElementById('as-switch').classList.add('active');
        document.getElementById('as-row-2').style.display = 'flex';
        // Expand bubble logic? CSS handles height if auto.
        // My CSS for .auto-summary-bubble doesn't have explicit height, so it expands naturally.
    }
    if (rounds) {
        autoSummaryTriggerRounds = parseInt(rounds);
        document.getElementById('as-trigger-val').innerText = autoSummaryTriggerRounds;
    }
    if (mems) memoryData = JSON.parse(mems);
    if (status) summaryStatus = JSON.parse(status);
}
// Call on load
loadAutoSummarySettings();

function toggleAutoSummary() {
    autoSummaryEnabled = !autoSummaryEnabled;
    const switchEl = document.getElementById('as-switch');
    const row2 = document.getElementById('as-row-2');
    
    if (autoSummaryEnabled) {
        switchEl.classList.add('active');
        // Slide down animation
        row2.style.display = 'flex';
    } else {
        switchEl.classList.remove('active');
        row2.style.display = 'none';
    }
    
    localStorage.setItem('as_enabled', autoSummaryEnabled);
    // Auto save, no toast needed for switch? "Modify confirm: ... saves automatically... prompt: Summary rounds saved" is for rounds.
    // Requirement says: "Switch toggle... automatically direct save".
}

function editTriggerRounds() {
    // Click interaction
    // Requirement: "Click value area, popup edit box". Use prompt for simplicity or custom modal?
    // "Pop up edit box" -> `prompt` is simplest and standard for this minimal simulation.
    const val = prompt("è¯·è¾“å…¥è§¦å‘è½®æ•°", autoSummaryTriggerRounds);
    if (val !== null && !isNaN(val) && val > 0) {
        autoSummaryTriggerRounds = parseInt(val);
        document.getElementById('as-trigger-val').innerText = autoSummaryTriggerRounds;
        localStorage.setItem('as_rounds', autoSummaryTriggerRounds);
        showToast("æ€»ç»“è½®æ•°å·²ä¿å­˜");
    }
}

// Chat Panel Logic
function toggleChatPanel() {
    const panel = document.getElementById('chat-ext-panel');
    const isOpen = panel.classList.contains('open');
    if (isOpen) {
        closeChatPanel();
    } else {
        panel.classList.add('open');
        // Scroll to bottom of chat to keep view stable?
        const chatBox = document.getElementById('chat-content');
        setTimeout(() => chatBox.scrollTop = chatBox.scrollHeight, 50);
    }
}

function closeChatPanel() {
    const panel = document.getElementById('chat-ext-panel');
    panel.classList.remove('open');
}

// Click outside to close
document.addEventListener('click', function(e) {
    const panel = document.getElementById('chat-ext-panel');
    const btn = document.querySelector('.chat-plus-btn');
    // If panel is open
    if (panel.classList.contains('open')) {
        // If click is NOT inside panel AND NOT the toggle button
        if (!panel.contains(e.target) && !btn.contains(e.target)) {
            closeChatPanel();
        }
    }
});

// Memory Screen Logic
function openMemoryScreen() {
    // Close chat panel first
    closeChatPanel();
    
    // Set title
    const f = friends[currentChatFriend];
    const name = f ? (f.customRemark || f.customNick || currentChatFriend) : currentChatFriend;
    document.getElementById('memory-screen-title').innerText = name + "çš„è®°å¿†";
    
    renderMemories();
    openScreen('memory-screen');
}

function renderMemories() {
    const list = document.getElementById('memory-list');
    list.innerHTML = "";
    const mems = memoryData[currentChatFriend] || [];
    
    mems.forEach(m => {
        const div = document.createElement('div');
        div.className = 'memory-bubble';
        div.innerHTML = `
            <div class="mem-icon-btn mem-edit-btn" onclick="editMemory('${m.id}')">âœ</div>
            <div class="mem-icon-btn mem-del-btn" onclick="deleteMemory('${m.id}')">ğŸ—‘ï¸</div>
            <div class="mem-content">${m.text}</div>
        `;
        list.appendChild(div);
    });
}

let pendingEditMemId = null;
function editMemory(id) {
    pendingEditMemId = id;
    const mems = memoryData[currentChatFriend] || [];
    const m = mems.find(x => x.id === id);
    if (m) {
        document.getElementById('edit-memory-text').value = m.text;
        document.getElementById('edit-memory-modal').style.display = 'flex';
    }
}

function confirmEditMemory() {
    const text = document.getElementById('edit-memory-text').value.trim();
    if (!text) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");
    
    const mems = memoryData[currentChatFriend];
    const idx = mems.findIndex(x => x.id === pendingEditMemId);
    if (idx !== -1) {
        mems[idx].text = text;
        saveMemoryData();
        renderMemories();
        document.getElementById('edit-memory-modal').style.display = 'none';
        showToast("è®°å¿†å·²æ›´æ–°");
    }
}

let pendingDelMemId = null;
function deleteMemory(id) {
    pendingDelMemId = id;
    document.getElementById('del-memory-modal').style.display = 'flex';
}

function confirmDeleteMemory() {
    const mems = memoryData[currentChatFriend] || [];
    memoryData[currentChatFriend] = mems.filter(x => x.id !== pendingDelMemId);
    saveMemoryData();
    renderMemories();
    document.getElementById('del-memory-modal').style.display = 'none';
    showToast("è¯¥è®°å¿†å·²æ¶ˆå¤±");
}

function saveMemoryData() {
    localStorage.setItem('wx_memories', JSON.stringify(memoryData));
}

// Auto Summary Logic
let generatedSummaryText = "";

async function checkAutoSummary(force = false) {
    if (!autoSummaryEnabled && !force) return;
    
    const msgs = chatHistory[currentChatFriend] || [];
    const status = summaryStatus[currentChatFriend] || { lastIndex: 0 };
    
    const totalMsgs = msgs.length;
    const newMsgsCount = totalMsgs - status.lastIndex;
    
    // 1 round = 2 messages (User + Char) ideally. 
    // Requirement: "User sent + Char reply finished = 1 round".
    // "From last summary count".
    // So roughly new messages / 2.
    const rounds = Math.floor(newMsgsCount / 2);
    
    if (force || rounds >= autoSummaryTriggerRounds) {
        // Trigger Summary
        const msgsToSummarize = msgs.slice(status.lastIndex);
        if (msgsToSummarize.length === 0) return;
        
        if (!force) {
            // Auto trigger
            await generateSummary(msgsToSummarize);
            // Update index only after success? Or assume processed?
            // "Summary content requirements... After completion... Pop up."
            // We should update index AFTER user saves or cancels? 
            // Requirement says "Save to memory -> close -> toast". "Cancel -> close".
            // If cancel, does it reset counter? Usually yes, otherwise it pops up again immediately.
            // Let's update index when generation starts or succeeds. 
            // Better to update after generation to avoid loops.
            status.lastIndex = totalMsgs;
            summaryStatus[currentChatFriend] = status;
            localStorage.setItem('as_status', JSON.stringify(summaryStatus));
        } else {
            // Manual trigger
             await generateSummary(msgsToSummarize);
             // Update index handled by caller or here?
             // Manual summary allows specifying rounds.
        }
    }
}

async function generateSummary(msgs) {
    // Show loading? Manual has loading toast. Auto usually background or just pops up?
    // Requirement for manual: "Click start -> Pop toast 'Generating...' -> Call AI".
    // Requirement for auto: "Trigger condition met -> Auto execute -> ... -> Pop up white box".
    // Let's show a loading toast for both to be safe and responsive.
    // Or reuse existing loading logic.
    
    // Construct Prompt
    const contentText = msgs.map(m => (m.type === 'self' ? "User: " : "Char: ") + m.text).join("\n");
    const prompt = `è¯·å¯¹ä»¥ä¸‹å¯¹è¯å†…å®¹è¿›è¡Œæ¦‚æ‹¬æ€»ç»“ã€‚
è¦æ±‚ï¼š
1. ä½¿ç”¨ç¬¬ä¸‰äººç§°å™è¿°ã€‚
2. ç”¨å†™å°è¯´çš„æ„Ÿè§‰è¿›è¡Œæ¦‚æ‹¬ã€‚
3. æŒ‰æ—¶é—´é¡ºåºè¿›è¡Œæ¦‚æ‹¬æ€»ç»“ã€‚
4. æ€»ç»“ä¸»è¦å†…å®¹ã€‚
5. å­—æ•°é™åˆ¶ï¼š600å­—ä»¥å†…ã€‚

å¯¹è¯å†…å®¹ï¼š
${contentText}`;

    try {
        const response = await fetch(`${apiSettings.url}/chat/completions`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiSettings.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: apiSettings.model,
                messages: [{role: "user", content: prompt}] // Use user role for prompt
            })
        });
        const data = await response.json();
        generatedSummaryText = data.choices[0].message.content;
        
        // Show Modal
        document.getElementById('summary-content').innerText = generatedSummaryText;
        document.getElementById('summary-modal').style.display = 'flex';
        
    } catch (e) {
        console.error(e);
        alert("æ€»ç»“ç”Ÿæˆå¤±è´¥");
    }
}

function saveSummaryToMemory() {
    const mems = memoryData[currentChatFriend] || [];
    mems.push({
        id: 'mem_' + Date.now(),
        text: generatedSummaryText,
        time: Date.now()
    });
    memoryData[currentChatFriend] = mems;
    saveMemoryData();
    
    document.getElementById('summary-modal').style.display = 'none';
    showToast("è¯¥æ€»ç»“å·²å­˜å…¥è®°å¿†");
    
    // Refresh memory screen if open?
    if (document.getElementById('memory-screen').style.display === 'flex') {
        renderMemories();
    }
}

// Manual Summary
function openManualSummary() {
    const msgs = chatHistory[currentChatFriend] || [];
    const status = summaryStatus[currentChatFriend] || { lastIndex: 0 };
    const unsumCount = msgs.length - status.lastIndex;
    const rounds = Math.floor(unsumCount / 2);
    
    document.getElementById('ms-detect-text').innerText = `å½“å‰æ£€æµ‹åˆ°${rounds}è½®å¯¹è¯æœªæ€»ç»“`;
    document.getElementById('ms-round-input').value = rounds;
    document.getElementById('manual-summary-modal').style.display = 'flex';
}

async function executeManualSummary() {
    const inputRounds = parseInt(document.getElementById('ms-round-input').value);
    if (!inputRounds || inputRounds <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆè½®æ•°");
    
    document.getElementById('manual-summary-modal').style.display = 'none';
    showToast("æ­£åœ¨ç”Ÿæˆæ€»ç»“ï¼Œè¯·ç¨å...");
    
    const msgs = chatHistory[currentChatFriend] || [];
    const status = summaryStatus[currentChatFriend] || { lastIndex: 0 };
    
    // Calculate start index based on requested rounds
    // "Process this time rounds (from earliest unprocessed message)"
    // So start from lastIndex. Take inputRounds * 2 messages.
    // If messages insufficient, take all available.
    
    const neededMsgs = inputRounds * 2;
    // Check available
    const available = msgs.length - status.lastIndex;
    // If user asks for more than available? Just take available.
    const sliceLen = Math.min(neededMsgs, available);
    
    // Wait, if user enters rounds manually, maybe they want to re-summarize old?
    // Requirement: "Input rounds to process (start from earliest unprocessed)".
    // So strictly `slice(lastIndex, lastIndex + neededMsgs)`.
    
    const msgsToSummarize = msgs.slice(status.lastIndex, status.lastIndex + sliceLen);
    
    await generateSummary(msgsToSummarize);
    
    // Update index
    status.lastIndex += sliceLen;
    summaryStatus[currentChatFriend] = status;
    localStorage.setItem('as_status', JSON.stringify(summaryStatus));
}

// --- MOMENTS FEATURE LOGIC ---

let momentsData = []; // [{ id, user, avatar, time, content, image, imgDesc, likes:[], comments:[], privacy:[] }]
let currentPubImg = null;
let currentPubDesc = "";
let currentPubPrivacy = []; // Empty = public
let activeMomentCommentId = null;
let activeCommentReplyTo = null; // "User" or null

// Load Data
function loadMomentsData() {
    const s_m = localStorage.getItem('wx_moments_data');
    if (s_m) momentsData = JSON.parse(s_m);
    const bg = localStorage.getItem('moments_bg');
    if (bg) document.getElementById('moments-bg-img').src = bg;
    
    // User info logic update
    const nick = localStorage.getItem('me_name') || "æˆ‘";
    const ava = localStorage.getItem('me_avatar') || "https://via.placeholder.com/70";
    document.getElementById('moments-user-nick').innerText = nick;
    // Set avatar for moment profile
    const bgAvatar = document.getElementById('moments-user-avatar');
    if(bgAvatar) bgAvatar.src = ava;
}
window.addEventListener('load', loadMomentsData); // Append to existing load or just call it if script runs late. 
// Note: windows.onload is already defined above. I will manually call this inside existing onload or just rely on 'openMoments' to refresh.
// Better: Add to the existing window.onload if possible, or just call openMoments which renders.

function openMoments() {
    loadMomentsData(); // Refresh user info
    renderMoments();
    document.getElementById('moments-screen').style.display = 'flex';
}

function closeMoments() {
    document.getElementById('moments-screen').style.display = 'none';
}

function changeMomentsBg() {
    // Just simple file picker re-use
    // Requirement: "User custom moments background".
    // I'll create a temp input for this.
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
        if (e.target.files[0]) {
            const r = new FileReader();
            r.onload = ev => {
                const url = ev.target.result;
                document.getElementById('moments-bg-img').src = url;
                localStorage.setItem('moments_bg', url);
            };
            r.readAsDataURL(e.target.files[0]);
        }
    };
    input.click();
}

function renderMoments() {
    const list = document.getElementById('moments-list');
    list.innerHTML = "";
    
    // Sort by time desc? Usually yes.
    // Assuming data is appended new (top), so iterate reverse or just store new at top.
    
    momentsData.forEach((m, index) => {
        // Render item
        const item = document.createElement('div');
        item.className = 'moments-item';
        
        let imgHtml = "";
        let descHtml = "";
        if (m.image) {
            imgHtml = `<img src="${m.image}" class="m-image" onclick="showFullImg('${m.image}')">`;
            // Check requirement: "If description... gray square box"
            if (m.imgDesc) {
descHtml = `<div class="m-desc-box">æŸ¥çœ‹æè¿°</div>`; // Hover or click? Req: "Show as gray rounded box with text 'View Description'". Functionality not specified deeply, maybe just static text? Or alert description?
                // Let's make it clickable to alert description for usability.
                descHtml = `<div class="m-desc-box" onclick="alert('${m.imgDesc.replace(/'/g, "\\'")}')">æŸ¥çœ‹æè¿°</div>`;
            }
        }
        
        // Likes HTML
        const hasLikes = m.likes && m.likes.length > 0;
        const likeHtml = m.likes ? m.likes.join('ï¼Œ') : '';
        
        // Comments HTML
        let commentsHtml = "";
        if (m.comments && m.comments.length > 0) {
            m.comments.forEach((c, cIdx) => {
                commentsHtml += `<div class="m-comment-item" onclick="replyComment('${m.id}', '${c.user}')"><span class="m-c-name">${c.user}</span>ï¼š${c.content}</div>`;
            });
        }
// Show/Hide interaction area
        const showInteract = hasLikes || (m.comments && m.comments.length > 0);
        
        item.innerHTML = `
            <img src="${m.avatar}" class="m-avatar">
            <div class="m-content">
<div class="m-name">${m.user}</div>
                ${m.content ? `<div class="m-text">${m.content}</div>` : ''}
                ${imgHtml}
                ${descHtml}
                <div class="m-footer">
                    <span class="m-time">${formatTime(m.time)}</span>
                    <div class="m-actions-btn" onclick="toggleMomentMenu(event, '${m.id}')">â€¢â€¢</div>
                </div>
                
                <!-- Pop Menu -->
                <div id="m-menu-${m.id}" class="m-menu-pop">
                    <div class="m-menu-item" onclick="likeMoment('${m.id}')">â¤ï¸ èµ</div>
                    <div class="m-menu-line"></div>
                    <div class="m-menu-item" onclick="openCommentInput('${m.id}')">ğŸ’¬ è¯„è®º</div>
                    ${m.user === currentUserName ? `<div class="m-menu-line"></div><div class="m-menu-item" onclick="deleteMoment('${m.id}')">ğŸ—‘ï¸ åˆ é™¤</div>` : ''}
                </div>
                
                <!-- Interaction Area -->
                <div class="m-interact-area ${showInteract ? 'show' : ''}">
                    <div class="m-likes ${hasLikes ? 'show' : ''}">
                        <span class="m-like-icon">â™¡</span>
                        <span id="m-like-text-${m.id}">${likeHtml}</span>
                    </div>
                    <div class="m-comments" id="m-comments-${m.id}">
                        ${commentsHtml}
                    </div>
                </div>
            </div>
        `;
        list.appendChild(item);
    });
    
    // Global click to close menus
    document.onclick = function(e) {
        if (!e.target.classList.contains('m-actions-btn')) {
            document.querySelectorAll('.m-menu-pop').forEach(el => el.style.display = 'none');
        }
    };
}

function formatTime(ts) {
    // Req: X min ago / X hour ago / X day ago
    const now = Date.now();
    const diff = (now - ts) / 1000; // seconds
    if (diff < 60) return "åˆšåˆš";
    if (diff < 3600) return Math.floor(diff/60) + "åˆ†é’Ÿå‰";
    if (diff < 86400) return Math.floor(diff/3600) + "å°æ—¶å‰";
    return Math.floor(diff/86400) + "å¤©å‰";
}

// Interaction
function toggleMomentMenu(e, id) {
    e.stopPropagation();
    // Close others
    document.querySelectorAll('.m-menu-pop').forEach(el => el.style.display = 'none');
    const menu = document.getElementById('m-menu-' + id);
    if(menu) menu.style.display = 'flex';
}

function likeMoment(id) {
    const m = momentsData.find(x => x.id === id);
    if (!m) return;
    
    // Check if I liked
    if (!m.likes) m.likes = [];
    const myName = currentUserName;
    if (m.likes.includes(myName)) {
        m.likes = m.likes.filter(n => n !== myName);
    } else {
        m.likes.push(myName);
    }
    saveMomentsData();
    renderMoments();
}

function deleteMoment(id) {
    if (!confirm("ç¡®è®¤åˆ é™¤è¿™æ¡æœ‹å‹åœˆå—ï¼Ÿ")) return;
    momentsData = momentsData.filter(x => x.id !== id);
    saveMomentsData();
    renderMoments();
}

function openCommentInput(id, replyTo = null) {
    activeMomentCommentId = id;
    activeCommentReplyTo = replyTo;
    
    const bar = document.getElementById('m-comment-bar');
    const input = document.getElementById('m-comment-input');
    bar.style.display = 'flex';
    input.value = "";
    input.placeholder = replyTo ? `å›å¤${replyTo}...` : "è¯„è®º...";
    input.focus();
}

function replyComment(mId, user) {
    // Only if not me? Req: "Click comment list... pop input box 'Reply xx'..."
    // If it's me, usually delete option in WeChat, but here simplified to reply logic.
    // Let's assume we can reply to anyone.
    openCommentInput(mId, user);
}

function sendMomentComment() {
    const text = document.getElementById('m-comment-input').value.trim();
    if (!text) return;
    
    const m = momentsData.find(x => x.id === activeMomentCommentId);
    if (!m) return;
    
    if (!m.comments) m.comments = [];
    
    let contentStr = text;
    // Format: "Name: Content" or "Name reply Name: Content"
    // My data structure stores `{user: "Me", content: "..."}`.
    // If replyTo is active, content should handle the "Reply X" text visually?
    // Requirement format: "CharRemark reply UserNick: Content".
    // So if I am replying: "Me reply X: content".
    
    if (activeCommentReplyTo) {
        // Store the prefix in content or structure? 
        // Simplest: put in content.
        contentStr = `å›å¤ ${activeCommentReplyTo}ï¼š${text}`;
    }
    
    const newComment = {
        user: currentUserName,
        content: contentStr,
        isUser: true // Mark as user comment
    };
    
    m.comments.push(newComment);
    saveMomentsData();
    renderMoments();
    
    document.getElementById('m-comment-bar').style.display = 'none';
    
    // AI TRIGGER for User Reply
    // Requirement: "If user replied to char's comment, char needs to reply back".
    if (activeCommentReplyTo) {
        // Check if activeCommentReplyTo matches a friend/AI
        if (friends[activeCommentReplyTo] || myBios.find(b=>b.nick === activeCommentReplyTo)) {
             // It's a character. Trigger AI reply flow.
             triggerAiMomentsReply(activeMomentCommentId, activeCommentReplyTo, text);
        }
    }
    
    activeMomentCommentId = null;
    activeCommentReplyTo = null;
}

// Publish Flow
function openPubModal() {
    // Clear
    document.getElementById('pub-text').value = "";
    removePubImg();
    clearPubDesc();
    currentPubPrivacy = [];
    document.getElementById('pub-privacy-text').innerText = "å…¬å¼€";
    
    document.getElementById('pub-moments-modal').style.display = 'flex';
}

function closePubModal() {
    document.getElementById('pub-moments-modal').style.display = 'none';
}

function handlePubImgSelect(input) {
    if (input.files && input.files[0]) {
        const r = new FileReader();
        r.onload = e => {
            currentPubImg = e.target.result;
            document.getElementById('pub-img-preview').src = currentPubImg;
            document.getElementById('pub-img-box').style.display = 'block';
            // Disable upload btn? "After upload, icon gray unclickable".
            // Visual feedback: I can style the button or just logic. 
            // Keeping simple.
        };
        r.readAsDataURL(input.files[0]);
    }
}

function removePubImg() {
    currentPubImg = null;
document.getElementById('pub-img-box').style.display = 'none';
    document.getElementById('pub-img-input').value = "";
}

function openDescModal() {
    document.getElementById('img-desc-input').value = currentPubDesc;
    document.getElementById('img-desc-modal').style.display = 'flex';
}

function saveImgDesc() {
    currentPubDesc = document.getElementById('img-desc-input').value.trim();
    if (currentPubDesc) {
        document.getElementById('pub-desc-preview').style.display = 'block';
    } else {
        document.getElementById('pub-desc-preview').style.display = 'none';
    }
    document.getElementById('img-desc-modal').style.display = 'none';
}

function clearPubDesc() {
    currentPubDesc = "";
document.getElementById('pub-desc-preview').style.display = 'none';
}

function openPrivacyModal() {
    const list = document.getElementById('privacy-list');
    list.innerHTML = "";
    // List all friends
    for (let fName in friends) {
        const item = document.createElement('div');
        item.className = 'list-check-item';
        const isChecked = currentPubPrivacy.includes(fName);
        item.innerHTML = `<div class="check-circle ${isChecked ? 'checked' : ''}" data-name="${fName}"></div><span>${fName}</span>`;
        item.onclick = function() {
            this.querySelector('.check-circle').classList.toggle('checked');
        };
        list.appendChild(item);
    }
    document.getElementById('privacy-modal').style.display = 'flex';
}

function savePrivacy() {
    const arr = [];
    document.querySelectorAll('#privacy-list .check-circle.checked').forEach(el => {
        arr.push(el.getAttribute('data-name'));
    });
    currentPubPrivacy = arr;
    
    const txt = arr.length > 0 ? "éƒ¨åˆ†å¯è§ (" + arr.length + "äºº)" : "å…¬å¼€";
    document.getElementById('pub-privacy-text').innerText = txt;
    
    if (arr.length > 0) {
        document.getElementById('pub-privacy-preview').style.display = 'block';
    } else {
        document.getElementById('pub-privacy-preview').style.display = 'none'; // Or block 'Public'
    }
    
    document.getElementById('privacy-modal').style.display = 'none';
}

function publishMoment() {
    const text = document.getElementById('pub-text').value.trim();
    if (!text && !currentPubImg) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");
    
    const newM = {
        id: 'm_' + Date.now(),
        user: currentUserName,
        avatar: currentUserAvatar || "https://via.placeholder.com/60",
        content: text,
        image: currentPubImg,
        imgDesc: currentPubDesc,
        time: Date.now(),
        privacy: currentPubPrivacy, // If empty, all. If not empty, only these.
        likes: [],
        comments: []
    };

    // Add to top
    momentsData.unshift(newM);
    saveMomentsData();
    renderMoments();
    closePubModal();
    
    // TRIGGER AI
    triggerAiMomentsInteraction(newM);
}

function saveMomentsData() {
    localStorage.setItem('wx_moments_data', JSON.stringify(momentsData));
}

// AI MOMENTS LOGIC
async function triggerAiMomentsInteraction(moment) {
    if (!apiSettings.key) return; // Silent fail if no API
    
    // Determine visible friends
    let visibleFriends = [];
    if (moment.privacy && moment.privacy.length > 0) {
        visibleFriends = moment.privacy; // Names
    } else {
        visibleFriends = Object.keys(friends); // All
    }
    
    // Loop each friend and decide
    for (const fName of visibleFriends) {
        const friendData = friends[fName];
        if (!friendData) continue;
        
        // Context
        // Need last 3 rounds of chat? 
        const history = chatHistory[fName] || [];
        const recentChat = history.slice(-6).map(m => (m.type === 'self' ? "User: " + m.text : fName + ": " + m.text)).join("\n");
        
        const role = friendData.customBio || friendData.bio || "æ™®é€šæœ‹å‹";
        
        const systemPrompt = `ä½ æ­£åœ¨æ‰®æ¼”å¾®ä¿¡å¥½å‹"${fName}"ã€‚
äººè®¾ï¼š${role}ã€‚
ä½ çš„å¥½å‹(User)åˆšåˆšå‘äº†ä¸€æ¡æœ‹å‹åœˆã€‚
å†…å®¹ï¼š${moment.content || "[æ— æ–‡å­—]"}
${moment.image ? "[é™„å¸¦äº†ä¸€å¼ å›¾ç‰‡]" : ""}
${moment.imgDesc ? "å›¾ç‰‡ç”»é¢æè¿°ï¼š" + moment.imgDesc : ""}

ä½ å’Œä»–çš„æœ€è¿‘èŠå¤©è®°å½•ï¼š
${recentChat}

ä»»åŠ¡ï¼š
1. å†³å®šæ˜¯å¦ç‚¹èµ (yes/no)ã€‚
2. å†³å®šæ˜¯å¦è¯„è®º (å¦‚æœè¯„è®ºï¼Œè¯·ç›´æ¥è¾“å‡ºå†…å®¹ï¼›å¦‚æœä¸è¯„è®ºï¼Œè¾“å‡º 'no')ã€‚
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼š{"like": boolean, "comment": "string or null"}
`;

        try {
            const res = await fetch(`${apiSettings.url}/chat/completions`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiSettings.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: apiSettings.model,
                    messages: [{role: "system", content: systemPrompt}],
                    response_format: { type: "json_object" } // Try JSON mode if supported
                })
            });
            
            // Many basic APIs won't support json_object strictly or formatting.
            // Let's settle for simple parsing or asking for raw format.
            // If the model doesn't support JSON mode, prompt eng is key.
            
            const data = await res.json();
let content = data.choices[0].message.content;
            
            // Try parse JSON
            let result = { like: false, comment: null };
            try {
                // Find first '{' and last '}'
                const s = content.indexOf('{');
                const e = content.lastIndexOf('}');
                if (s >= 0 && e >= 0) {
                    result = JSON.parse(content.substring(s, e+1));
                }
            } catch(e) {
                console.log("JSON parse fail", e);
            }
            
            // Execute
if (result.like) {
                if (!moment.likes) moment.likes = [];
                if (!moment.likes.includes(fName)) moment.likes.push(fName);
            }
            if (result.comment && result.comment !== 'no' && result.comment !== 'null') {
                if (!moment.comments) moment.comments = [];
                moment.comments.push({
                    user: fName,
                    content: result.comment
                });
            }
            
            // Save and Render per friend to look natural (with delay?)
            setTimeout(() => {
saveMomentsData();
                renderMoments();
            }, Math.random() * 5000 + 2000); // Random delay 2-7s
            
        } catch (e) {
            console.error("AI Moment Interaction Error", e);
        }
    }
}

async function triggerAiMomentsReply(momentId, charName, userReplyText) {
    if (!apiSettings.key) return;
    
    const m = momentsData.find(x => x.id === momentId);
    if (!m) return;
    
    const friendData = friends[charName];
    if (!friendData) return;
    
    // Find context: The comment thread?
    // Simplified: Just "User replied to your comment on moments: [text]"
    
    const role = friendData.customBio || friendData.bio;
    
    const prompt = `ä½ æ­£åœ¨æ‰®æ¼”"${charName}" (äººè®¾:${role})ã€‚
å¥½å‹(User)åœ¨æœ‹å‹åœˆå›å¤äº†ä½ çš„è¯„è®ºã€‚
Userçš„å›å¤å†…å®¹: "${userReplyText}"
è¿™æ¡æœ‹å‹åœˆåŸå§‹å†…å®¹: "${m.content}"

è¯·å›å¤Userã€‚ä¸è¦å¸¦IDï¼Œç›´æ¥è¾“å‡ºå›å¤å†…å®¹ã€‚`;

    try {
        const res = await fetch(`${apiSettings.url}/chat/completions`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiSettings.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: apiSettings.model,
                messages: [{role: "user", content: prompt}]
            })
        });
        const data = await res.json();
        const reply = data.choices[0].message.content.trim();
        
        if (reply) {
            if (!m.comments) m.comments = [];
            // Format: "CharName reply UserNick: Content"
            m.comments.push({
                user: charName,
                content: `å›å¤ ${currentUserName}ï¼š${reply}`
            });
            
            setTimeout(() => {
                saveMomentsData();
                renderMoments();
            }, 3000);
        }
    } catch (e) { console.error(e); }
}

// Moments Generation (Settings Sidebar)
function openMomentsSettings() {
    const list = document.getElementById('ms-friend-list');
    list.innerHTML = "";
    for (let fName in friends) {
        const item = document.createElement('div');
        item.className = 'list-check-item'; // Reuse
        item.innerHTML = `<div class="check-circle" data-name="${fName}"></div><span>${fName}</span>`;
        item.onclick = function() {
            this.querySelector('.check-circle').classList.toggle('checked');
        };
        list.appendChild(item);
    }
    
    document.getElementById('moments-settings-sidebar').classList.add('open');
    document.getElementById('ms-overlay').style.display = 'block';
}

function closeMomentsSettings() {
    document.getElementById('moments-settings-sidebar').classList.remove('open');
    document.getElementById('ms-overlay').style.display = 'none';
}

async function generateAiMoments() {
    const selected = [];
    document.querySelectorAll('#ms-friend-list .check-circle.checked').forEach(el => selected.push(el.getAttribute('data-name')));
    
    if (selected.length === 0) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¥½å‹");
    
    showToast("æ­£åœ¨è¯·æ±‚AIç”Ÿæˆ...");
    closeMomentsSettings();
    
    for (const name of selected) {
        // Generate content
        const friendData = friends[name];
        const role = friendData.customBio || friendData.bio;
        // Recent chat context
        const history = chatHistory[name] || [];
        const recentChat = history.slice(-6).map(m => (m.type === 'self' ? "User: " + m.text : name + ": " + m.text)).join("\n");
const prompt = `ä½ æ‰®æ¼”"${name}" (äººè®¾:${role})ã€‚
è¯·ç»“åˆä½ å’Œå¥½å‹(User)çš„æœ€è¿‘èŠå¤©è®°å½•ï¼š
${recentChat}

è¯·åˆ›ä½œä¸€æ¡ç¬¦åˆä½ äººè®¾çš„æœ‹å‹åœˆå†…å®¹ã€‚
è¦æ±‚ï¼š
1. å†…å®¹å¿…é¡»ç”Ÿæ´»åŒ–ï¼ŒåƒçœŸå®æœ‹å‹åœˆã€‚
2. å¯ä»¥ç®€çŸ­ã€‚
3. è¯·åªè¾“å‡ºå†…å®¹æ–‡æœ¬ï¼Œä¸è¦å…¶ä»–åºŸè¯ã€‚`;

        try {
            const res = await fetch(`${apiSettings.url}/chat/completions`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiSettings.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: apiSettings.model,
                    messages: [{role: "user", content: prompt}]
                })
            });
            const data = await res.json();
            const content = data.choices[0].message.content.trim();
            
            // Add to data
            momentsData.unshift({
                id: 'm_' + Date.now() + Math.floor(Math.random()*100),
                user: name,
                avatar: friendData.avatar,
                content: content,
                image: null, // AI image gen not supported in this env
                time: Date.now(),
                likes: [],
                comments: []
            });
            
        } catch(e) { console.error(e); }
    }
    
    setTimeout(() => {
saveMomentsData();
        renderMoments();
        showToast("ç”Ÿæˆå®Œæˆï¼Œä¸‹æ‹‰åˆ·æ–°æŸ¥çœ‹(å·²è‡ªåŠ¨åˆ·æ–°)");
    }, 2000);
}

</script>
</body>
</html>
